<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>シフト希望入力</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --bg: #f4f7f9; --sat: #007bff; --sun: #dc3545; --error-bg: #ffebeb; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #333; font-size: 18px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); box-sizing: border-box; }
        
       h1 { 
    text-align: center; 
    font-size: 1.6rem; 
    color: #222; 
    margin-bottom: 20px; 
    line-height: 1.4;
    white-space: normal; /* タグの改行に任せる */
}

        .msg-box { 
    background: #f0f7ff; 
    padding: 15px; 
    border-radius: 8px; 
    margin-bottom: 20px; 
    font-size: 1rem; 
    border-left: 5px solid var(--primary); 
    white-space: normal; /* タグの改行に任せる */
}

/* リッチエディタ内の改行(div)による余分な隙間を消す */
h1 div, .msg-box div { margin: 0; padding: 0; }
        
        input[type="text"], textarea { width: 100%; padding: 15px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; margin-bottom: 20px; font-size: 18px; }
        
        .calendar-wrapper { border: 1px solid #eee; border-radius: 8px; overflow: hidden; margin-bottom: 20px; }
        .weekday-header { display: grid; grid-template-columns: repeat(7, 1fr); background: #eee; text-align: center; font-weight: bold; font-size: 0.9rem; padding: 10px 0; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #eee; max-height: 400px; overflow-y: auto; width: 100%; }
        
        .day-cell { background: #fff; aspect-ratio: 1/1.4; display: flex; flex-direction: column; align-items: center; padding: 4px 1px; cursor: pointer; font-size: 1rem; transition: background 0.3s; box-sizing: border-box; min-width: 0; overflow-y: auto; }
        .day-cell.is-error { background: var(--error-bg); border: 2px solid var(--danger) !important; }
        .day-cell span { font-weight: bold; }
        
        .weekday-header div:nth-child(7), .day-cell:nth-child(7n) span { color: var(--sat); }
        .weekday-header div:nth-child(1), .day-cell:nth-child(7n+1) span { color: var(--sun); }
        
        .shift-display { display: flex; flex-direction: column; width: 100%; align-items: center; margin-top: 4px; }
        .shift-tag { font-size: 0.65rem; color: var(--primary); font-weight: bold; line-height: 1.1; text-align: center; width: 100%; word-break: break-all; white-space: normal; margin-top: 2px; display: block; }
        .shift-tag.is-off { color: var(--danger); }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; width: 95%; max-width: 450px; border-radius: 15px; padding: 25px; box-sizing: border-box; }
        
        .shift-options { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 25px 0; }
        .shift-btn { padding: 18px 5px; border: 2px solid var(--primary); background: white; color: var(--primary); border-radius: 10px; cursor: pointer; font-size: 1rem; font-weight: bold; }
        .shift-btn.active { background: var(--primary); color: white; }
        .shift-btn.is-off-btn { border-color: var(--danger); color: var(--danger); }
        .shift-btn.is-off-btn.active { background: var(--danger); color: white; }
        
        .modal-footer { display: flex; gap: 10px; }
        .btn { border: none; border-radius: 10px; font-weight: bold; cursor: pointer; padding: 18px; font-size: 1.1rem; }
        .btn-confirm { background: var(--success); color: white; flex: 2; }
        .btn-clear { background: var(--danger); color: white; flex: 1; }
        
        #confirm-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; padding: 20px; overflow-y: auto; box-sizing: border-box; }
        
        /* 確認画面のメッセージも改行有効化 */
        .confirm-msg { white-space: pre-wrap; margin-bottom: 20px; }
        .summary-item { padding: 12px 0; border-bottom: 1px solid #eee; font-size: 1.1rem; }
    </style>
</head>
<body>

    <div id="passcode-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; flex-direction:column; align-items:center; justify-content:center; font-family:sans-serif; padding:20px; box-sizing:border-box;">
    <div style="max-width:400px; width:100%; text-align:center;">
        <h2 id="pass-title" style="color:#333; margin-bottom:20px;">パスコードが必要です</h2>
        <p style="color:#666; margin-bottom:20px;">管理者に案内されたパスコードを入力してください。</p>
        <input type="text" id="pass-input" placeholder="パスコードを入力" style="width:100%; padding:15px; font-size:1.2rem; border:2px solid #ddd; border-radius:8px; margin-bottom:20px; text-align:center; box-sizing:border-box;">
        <button id="pass-submit" style="width:100%; padding:15px; background:#007bff; color:white; border:none; border-radius:8px; font-size:1.1rem; cursor:pointer;">認証する</button>
        <div id="pass-error" style="color:#e53e3e; margin-top:15px; display:none;">パスコードが違います</div>
    </div>
</div>

<div class="container" id="input-screen">
    <h1 id="h1-title">読み込み中...</h1>
    <div id="msg-top" class="msg-box"></div>
    <label>氏名（必須）</label>
    <input type="text" id="staff-name" placeholder="お名前を入力">
    <div id="msg-calendar" class="msg-box"></div>
    <div class="calendar-wrapper">
        <div class="weekday-header">
            <div>日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div>土</div>
        </div>
        <div id="calendar" class="calendar-grid"></div>
    </div>
    <div id="msg-bottom" class="msg-box"></div> 
    <label>備考・その他希望</label>
    <textarea id="free-text" rows="3" placeholder="特記事項があれば入力"></textarea>
    <button class="btn btn-confirm" style="width:100%;" onclick="showSummary()">内容確認ボタン</button>
</div>

<div id="shift-modal" class="modal">
    <div class="modal-content">
        <h3 id="modal-date-display" style="text-align:center; margin-top:0; font-size:1.3rem;">日付</h3>
        <div id="shift-options" class="shift-options"></div>
        <div class="modal-footer">
            <button class="btn btn-clear" onclick="clearTemp()">クリア</button>
            <button class="btn btn-confirm" onclick="applyShift()">決定</button>
        </div>
        <button onclick="closeModal()" style="display:block; width:100%; margin-top:20px; font-size:1rem; border:none; background:none; color:gray;">閉じる</button>
    </div>
</div>

<div id="confirm-screen">
    <h2 style="text-align:center;">入力内容の確認</h2>
    <div id="msg-confirm" class="msg-box"></div> 
    <div id="summary-content"></div>
    <div style="margin: 20px 0; display: flex; flex-direction: column; gap: 15px;">
        <button class="btn" style="background:var(--primary); color:white;" onclick="copyToClipboard()">シフト希望内容をコピーする</button>
        <button class="btn" style="background:#666; color:white;" onclick="hideSummary()">戻って選択し直す</button>
        <button class="btn btn-confirm" onclick="submitFinal()">送信ボタン</button>
    </div>
</div>

<script>
    const SUBAPASE_URL = 'https://vryxvtzrvmtyryugqzlp.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_RnuLQC0N_wYOrwLFQIf5Gg_O-g_bc2m';
    
    function getCleanId() {
        const urlParams = new URLSearchParams(window.location.search);
        let rawId = urlParams.get('id') || 'cabb1760-a320-4d61-82c8-c2c069768d35';
        const uuidMatch = rawId.match(/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/i);
        return uuidMatch ? uuidMatch[0] : 'cabb1760-a320-4d61-82c8-c2c069768d35';
    }

    const PROJECT_ID = getCleanId();
    const db = supabase.createClient(SUBAPASE_URL, SUPABASE_KEY);
    const weekDays = ["日", "月", "火", "水", "木", "金", "土"];
    let shiftTypes = [];
    let selectedShifts = {}; 
    let currentFullDates = [];
    let targetMonthStr = "";

    async function init() {
        // --- 【追加】デモ・プレビュー用の注釈表示 ---
    const urlParams = new URLSearchParams(window.location.search);
    const isPreview = window.location.search.length > (window.location.search.indexOf(PROJECT_ID) + PROJECT_ID.length);
    if (isPreview) {
        const demoBanner = document.createElement('div');
        demoBanner.style.cssText = 'background:#f1f5f9; color:#475569; padding:10px; text-align:center; font-size:0.8rem; border-bottom:1px solid #e2e8f0; line-height:1.4;';
        demoBanner.innerHTML = '<strong>デモ・プレビューモード実行中</strong><br>テスト送信では「Aさん」や「Bさん」など実在しない名前で送信してください<br>実際のスタッフ用画面では一度送信すると翌月まで送信できない仕組みです';
        document.body.prepend(demoBanner);
    }
    const now = new Date();
    const nextMonthDate = new Date(now.getFullYear(), now.getMonth() + 1, 1);
    const y = nextMonthDate.getFullYear();
    const m = nextMonthDate.getMonth() + 1;
    targetMonthStr = `${y}-${m}`;
    const lockKey = `submitted_${targetMonthStr}_${PROJECT_ID}`;
    
    // 1. 送信済みチェック
    if (!isPreview && localStorage.getItem(lockKey)) {
        document.body.innerHTML = `
            <div style="padding:100px 20px; text-align:center; font-family:sans-serif;">
                <h2 style="color:#333;">送信済み</h2>
                <p style="color:#666;">${m}月分のシフト希望は既に提出されています。</p>
                <p style="font-size:0.9rem; color:#999;">※内容の変更が必要な場合は管理者に連絡してください。</p>
            </div>`;
        return;
    }

    try {
        const [pRes, sRes] = await Promise.all([
            db.from('projects').select('*').eq('id', PROJECT_ID).single(),
            db.from('shift_types').select('*').eq('project_id', PROJECT_ID).order('display_order', { ascending: true })
        ]);
        if (pRes.error || sRes.error) throw (pRes.error || sRes.error);

        const proj = pRes.data;
        shiftTypes = sRes.data;

        // --- ★パスコードチェック ---
        const correctPass = proj.passcode; 
        const savedPass = localStorage.getItem(`pass_${PROJECT_ID}`);
        const inputPass = urlParams.get('pw') || savedPass;

        if (correctPass && correctPass.trim() !== "" && inputPass !== correctPass) {
            const overlay = document.getElementById('passcode-overlay');
            overlay.style.display = 'flex';
            document.getElementById('pass-title').textContent = proj.title_tag || "閲覧制限";
            document.getElementById('pass-submit').onclick = () => {
                const userIn = document.getElementById('pass-input').value;
                if (userIn === correctPass) {
                    const separator = window.location.search.includes('?') ? '&' : '?';
                    localStorage.setItem(`pass_${PROJECT_ID}`, userIn);
location.href = window.location.pathname + "?id=" + PROJECT_ID;
                } else {
                    document.getElementById('pass-error').style.display = 'block';
                    document.getElementById('pass-input').value = '';
                }
            };
            return;
        }

        // --- ★並び順（form_config）の完全再現反映 ---
        const container = document.getElementById('input-screen');
        
        // スタッフ画面の各要素を「一式」として定義
        const elementMapping = {
            'h1_title': document.getElementById('h1-title'),
            'msg_top': document.getElementById('msg-top'),
            'name_label': document.querySelector('label[for="staff-name"]') || document.querySelector('label:nth-of-type(1)'),
            'name_input': document.getElementById('staff-name'),
            'msg_calendar': document.getElementById('msg-calendar'),
            'calendar_field': document.querySelector('.calendar-wrapper'),
            'msg_bottom': document.getElementById('msg-bottom'),
            'memo_label': document.querySelector('label:nth-of-type(2)'),
            'memo_input': document.getElementById('free-text'),
            'submit_btn': document.querySelector('button[onclick="showSummary()"]')
        };

        if (proj.form_config && Array.isArray(proj.form_config)) {
            proj.form_config.forEach(fieldId => {
                // 保存された順序に従って、要素を順番に「一番下」へ移動させていくことで並び替える
                if (fieldId === 'h1_title' && elementMapping['h1_title']) {
                    container.appendChild(elementMapping['h1_title']);
                } else if (fieldId === 'msg_top' && elementMapping['msg_top']) {
                    container.appendChild(elementMapping['msg_top']);
                    container.appendChild(elementMapping['name_label']);
                    container.appendChild(elementMapping['name_input']);
                } else if (fieldId === 'msg_calendar' && elementMapping['msg_calendar']) {
                    container.appendChild(elementMapping['msg_calendar']);
                    container.appendChild(elementMapping['calendar_field']);
                } else if (fieldId === 'msg_bottom' && elementMapping['msg_bottom']) {
                    container.appendChild(elementMapping['msg_bottom']);
                    container.appendChild(elementMapping['memo_label']);
                    container.appendChild(elementMapping['memo_input']);
                }
            });
            // 送信ボタンは常に一番最後（最下部）に配置する
            if (elementMapping['submit_btn']) {
                container.appendChild(elementMapping['submit_btn']);
            }
        }
        // --- ★反映終了 ---

        // 2. メッセージやタイトルの反映
        document.getElementById('h1-title').innerHTML = m + (proj.h1_title || "月のシフト希望");
        document.title = proj.title_tag || document.getElementById('h1-title').textContent;

        const config = { 'msg-top': proj.msg_top, 'msg-calendar': proj.msg_calendar, 'msg-bottom': proj.msg_bottom, 'msg-confirm': proj.msg_confirm };
        Object.keys(config).forEach(id => {
            const el = document.getElementById(id);
            if (config[id]) { 
                el.innerHTML = config[id]; 
                el.style.display = 'block'; 
            } else {
                el.style.display = 'none';
            }
        });

        // 3. カレンダー描画
        renderCalendar(nextMonthDate);

    } catch (e) { 
        document.getElementById('h1-title').textContent = "読み込みエラー";
        document.getElementById('msg-top').style.display = 'block';
        document.getElementById('msg-top').innerHTML = `設定が見つかりません。`;
    }
}

    function renderCalendar(baseDate) {
        const container = document.getElementById('calendar');
        container.innerHTML = '';
        const y = baseDate.getFullYear(), m = baseDate.getMonth();
        const firstDay = new Date(y, m, 1).getDay();
        const lastDate = new Date(y, m + 1, 0).getDate();
        for (let i = 0; i < firstDay; i++) {
            const empty = document.createElement('div');
            empty.className = 'day-cell';
            container.appendChild(empty);
        }
        for (let d = 1; d <= lastDate; d++) {
            const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            currentFullDates.push(dateStr); 
            const cell = document.createElement('div');
            cell.className = 'day-cell';
            cell.id = `cell-${dateStr}`;
            cell.innerHTML = `<span>${d}</span><div class="shift-display"></div>`;
            cell.onclick = () => openModal(dateStr, d, weekDays[new Date(y, m, d).getDay()]);
            container.appendChild(cell);
        }
    }

    function openModal(date, day, weekDay) {
        targetDate = date;
        document.getElementById('modal-date-display').textContent = `${date.split('-')[1]}月${day}日(${weekDay})の希望`;
        tempSelected = selectedShifts[date] ? [...selectedShifts[date]] : [];
        renderOptions();
        document.getElementById('shift-modal').style.display = 'flex';
    }

    function renderOptions() {
        const div = document.getElementById('shift-options');
        div.innerHTML = '';
        shiftTypes.forEach(t => {
            const b = document.createElement('button');
            b.className = `shift-btn ${tempSelected.includes(t.name) ? 'active' : ''}`;
            if (t.name.includes('休み')) b.classList.add('is-off-btn');
            b.textContent = t.name;
            b.onclick = () => {
                if (tempSelected.includes(t.name)) tempSelected = tempSelected.filter(x => x !== t.name);
                else tempSelected.push(t.name);
                renderOptions();
            };
            div.appendChild(b);
        });
    }

    function applyShift() {
        if (tempSelected.length > 0) {
            selectedShifts[targetDate] = [...tempSelected];
            document.getElementById(`cell-${targetDate}`).classList.remove('is-error');
        } else {
            delete selectedShifts[targetDate];
        }
        const display = document.getElementById(`cell-${targetDate}`).querySelector('.shift-display');
        display.innerHTML = (selectedShifts[targetDate] || []).map(s => `<div class="shift-tag ${s.includes('休み')?'is-off':''}">${s}</div>`).join('');
        closeModal();
    }

    function clearTemp() { tempSelected = []; renderOptions(); }
    function closeModal() { document.getElementById('shift-modal').style.display = 'none'; }

    function showSummary() {
        const name = document.getElementById('staff-name').value;
        if (!name) return alert("氏名を入力してください");
        let unselectedDays = [];
        currentFullDates.forEach(date => {
            const cell = document.getElementById(`cell-${date}`);
            cell.classList.remove('is-error');
            if (!selectedShifts[date] || selectedShifts[date].length === 0) {
                unselectedDays.push(date);
                cell.classList.add('is-error');
            }
        });
        if (unselectedDays.length > 0) {
            alert("未選択の日にちがあります。カレンダーの赤い枠の日にちを選択してください。");
            return;
        }
        const summary = document.getElementById('summary-content');
        summary.innerHTML = `<div class="summary-item"><strong>提出者:</strong> ${name} 様</div>`;
        currentFullDates.forEach(date => {
            const dObj = new Date(date);
            const formattedDate = `${dObj.getMonth()+1}/${dObj.getDate()}(${weekDays[dObj.getDay()]})`;
            summary.innerHTML += `<div class="summary-item"><strong>${formattedDate}:</strong> ${selectedShifts[date].join(', ')}</div>`;
        });
        const freeText = document.getElementById('free-text').value;
        if (freeText) summary.innerHTML += `<div class="summary-item" style="background:#f9f9f9; padding:10px;"><strong>備考:</strong><br>${freeText}</div>`;
        document.getElementById('confirm-screen').style.display = 'block';
    }

    function hideSummary() { document.getElementById('confirm-screen').style.display = 'none'; }

    async function submitFinal() {
        if (!confirm("送信しますか？")) return;
        try {
            const { error } = await db.from('submissions').insert([{
                project_id: PROJECT_ID,
                staff_name: document.getElementById('staff-name').value,
                shift_data: selectedShifts,
                memo: document.getElementById('free-text').value
            }]);
            if (error) throw error;
            localStorage.setItem(`submitted_${targetMonthStr}_${PROJECT_ID}`, "true");
            alert("送信完了しました！");
            location.reload(); 
        } catch (e) { alert("送信エラー: " + e.message); }
    }

    function copyToClipboard() {
        navigator.clipboard.writeText(document.getElementById('summary-content').innerText).then(() => alert("コピーしました"));
    }

    init();
</script>
</body>
</html>










