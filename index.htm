<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シフト希望提出</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <style>
        :root { --primary-color: #4361ee; --bg-color: #f8f9fa; }
        body { font-family: sans-serif; background-color: var(--bg-color); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: var(--primary-color); font-size: 1.5rem; text-align: center; margin-bottom: 10px; }
        .msg-box { background: #f1f3f9; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 0.9rem; line-height: 1.6; white-space: pre-wrap; }
        #calendar { margin-bottom: 20px; background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], input[type="email"], select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn-submit { background: var(--primary-color); color: white; border: none; padding: 15px 30px; border-radius: 30px; width: 100%; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 20px; }
        /* カレンダー内のイベントスタイル */
        .fc-event { cursor: pointer; padding: 2px 5px; }
    </style>
</head>
<body>

<div class="container">
    <h1 id="display-h1">--月の希望シフト</h1>
    
    <div id="msg-top" class="msg-box"></div>

    <div id="msg-calendar" style="font-size: 0.85rem; color: #666; margin-bottom: 10px;"></div>
    <div id="calendar"></div>

    <div class="form-group">
        <label>氏名</label>
        <input type="text" id="user-name" placeholder="例：山田 太郎">
    </div>

    <div id="msg-bottom" class="msg-box" style="background: transparent; border-left: 4px solid #ddd;"></div>

    <button class="btn-submit" onclick="submitShift()">提出内容を確認する</button>
</div>

<script>
    const S_URL = 'https://vryxvtzrvmtyryugqzlp.supabase.co';
    const S_KEY = 'sb_publishable_RnuLQC0N_wYOrwLFQIf5Gg_O-g_bc2m';
    const client = supabase.createClient(S_URL, S_KEY);

    let calendar;
    let selectedShifts = {}; // { "2023-10-01": "9:00-18:00" }
    let shiftTypes = [];
    let projectData = null;

    // 来月の月を取得する関数
    function getNextMonth() {
        const now = new Date();
        return (now.getMonth() + 1) % 12 + 1; 
    }

    async function init() {
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');
        if (!projectId) {
            alert("案件IDが指定されていません");
            return;
        }

        // 1. プロジェクト情報の取得
        const { data: pj, error: pError } = await client.from('projects').select('*').eq('id', projectId).single();
        if (pError || !pj) return alert("案件データが見つかりません");
        projectData = pj;

        // 2. シフト枠の取得
        const { data: st, error: sError } = await client.from('shift_types').select('*').eq('project_id', projectId).order('display_order');
        shiftTypes = st || [];

        renderPage();
        renderCalendar();
    }

    function renderPage() {
        // --- H1タイトルの自動置換 ---
        const nextMonth = getNextMonth();
        let title = projectData.h1_title || "{{month}}月の希望シフト";
        
        // もし設定に {{month}} があれば置換、なければ先頭に月を付ける
        if (title.includes("{{month}}")) {
            title = title.replace("{{month}}", nextMonth);
        } else if (!title.includes(nextMonth + "月")) {
            title = nextMonth + "月 " + title;
        }
        
        document.getElementById('display-h1').textContent = title;
        document.title = projectData.title_tag || title;

        // メッセージ類の反映
        document.getElementById('msg-top').textContent = projectData.msg_top || "";
        document.getElementById('msg-calendar').textContent = projectData.msg_calendar || "日付をクリックしてシフトを選択してください";
        document.getElementById('msg-bottom').textContent = projectData.msg_bottom || "";
    }

    function renderCalendar() {
        const calendarEl = document.getElementById('calendar');
        const nextMonthDate = new Date();
        nextMonthDate.setMonth(nextMonthDate.getMonth() + 1);

        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            initialDate: nextMonthDate,
            locale: 'ja',
            contentHeight: 'auto',
            selectable: true,
            dateClick: function(info) {
                showShiftPicker(info.dateStr);
            },
            events: []
        });
        calendar.render();
    }

    function showShiftPicker(dateStr) {
        if (shiftTypes.length === 0) return;

        // シフト選択の簡易プロンプト（実用上はカスタムモーダルが望ましいですが、一旦シンプルに）
        let options = shiftTypes.map((t, idx) => `${idx + 1}: ${t.name}`).join('\n');
        let choice = prompt(`${dateStr}\nシフトを選択してください:\n${options}\n(未入力でクリア)`);

        if (choice === null) return; 
        
        const selectedIndex = parseInt(choice) - 1;
        if (shiftTypes[selectedIndex]) {
            selectedShifts[dateStr] = shiftTypes[selectedIndex].name;
        } else {
            delete selectedShifts[dateStr];
        }
        updateCalendarEvents();
    }

    function updateCalendarEvents() {
        const events = Object.keys(selectedShifts).map(date => ({
            title: selectedShifts[date],
            start: date,
            allDay: true,
            backgroundColor: selectedShifts[date] === "休み" ? "#999" : "#4361ee"
        }));
        calendar.removeAllEvents();
        calendar.addEventSource(events);
    }

    async function submitShift() {
        const name = document.getElementById('user-name').value;
        if (!name) return alert("お名前を入力してください");
        if (Object.keys(selectedShifts).length === 0) return alert("シフトを1日以上選択してください");

        // 確認ダイアログ
        const summary = Object.entries(selectedShifts).map(([d, s]) => `${d}: ${s}`).join('\n');
        if (!confirm(`${name}様、以下の内容で提出しますか？\n\n${summary}`)) return;

        // 保存処理
        const { error } = await client.from('submissions').insert([{
            project_id: projectData.id,
            user_name: name,
            shifts: selectedShifts
        }]);

        if (error) {
            alert("エラーが発生しました: " + error.message);
        } else {
            alert("提出が完了しました。ありがとうございました。");
            location.reload();
        }
    }

    init();
</script>

</body>
</html>
