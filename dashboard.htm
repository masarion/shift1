<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>シフト管理ダッシュボード</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #4f46e5; --bg: #f9fafb; --text: #111827; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; }
        #auth-container { position: fixed; inset: 0; background: white; display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .auth-box { width: 350px; padding: 30px; border: 1px solid #e5e7eb; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .auth-box input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #d1d5db; border-radius: 6px; box-sizing: border-box; }
        #sidebar { width: 240px; background: #1f2937; color: white; padding: 20px; flex-shrink: 0; }
        #main-content { flex-grow: 1; overflow-y: auto; padding: 30px; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .nav-item { padding: 12px; cursor: pointer; border-radius: 6px; margin-bottom: 5px; }
        .nav-item:hover { background: #374151; }
        .nav-active { background: var(--primary); }
        button { padding: 8px 16px; border-radius: 6px; cursor: pointer; border: none; font-weight: bold; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #edf2f7; color: #4a5568; }
        .btn-danger { background: #fee2e2; color: #dc2626; padding: 4px 10px; font-size: 0.8rem; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; }
        .form-group input, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .shift-item { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; background: #f8fafc; padding: 8px; border-radius: 4px; }
        .shift-item input { flex-grow: 1; }
    </style>
</head>
<body>

<div id="auth-container">
    <div class="auth-box">
        <h2>管理者ログイン</h2>
        <input type="email" id="email" placeholder="メールアドレス">
        <input type="password" id="password" placeholder="パスワード">
        <button class="btn-primary" style="width:100%" onclick="login()">ログイン</button>
    </div>
</div>

<div id="sidebar">
    <h3>シフト管理</h3>
    <div class="nav-item nav-active" onclick="showSection('projects')">案件一覧</div>
    <div class="nav-item" onclick="showSection('edit-all')">ページ・シフト枠編集</div>
    <div class="nav-item" onclick="showSection('qr-gen')">URL・QR作成</div>
    <div style="margin-top: 50px;">
        <p id="user-display" style="font-size: 0.8rem; color: #9ca3af;"></p>
        <button onclick="logout()" style="background:transparent; color:#9ca3af; border:1px solid #4b5563; width: 100%;">ログアウト</button>
    </div>
</div>

<div id="main-content">
    <section id="sec-projects">
        <h1>案件一覧</h1>
        <div class="card"><button class="btn-primary" onclick="createNewProject()">+ 新規案件を作成</button></div>
        <div id="project-list-container"></div>
    </section>

    <section id="sec-edit-all" style="display:none;">
        <h1>ページ内容とシフト枠の編集</h1>
        <div id="current-pj-name" style="margin-bottom:15px; color: var(--primary); font-weight: bold;"></div>
        
        <div style="display: flex; gap: 20px; align-items: flex-start;">
            <div class="card" style="flex: 1;">
                <h3>① ページ表示設定</h3>
                <div class="form-group"><label>管理用名称 (title_tag)</label><input type="text" id="field-title_tag"></div>
                <div class="form-group"><label>画面トップタイトル (h1_title)</label><input type="text" id="field-h1_title"></div>
                <div class="form-group"><label>冒頭メッセージ (msg_top)</label><textarea id="field-msg_top" rows="2"></textarea></div>
                <div class="form-group"><label>カレンダー操作説明 (msg_calendar)</label><textarea id="field-msg_calendar" rows="2"></textarea></div>
                <div class="form-group"><label>フォーム説明 (msg_bottom)</label><textarea id="field-msg_bottom" rows="2"></textarea></div>
                <div class="form-group"><label>確認画面注意書き (msg_confirm)</label><textarea id="field-msg_confirm" rows="2"></textarea></div>
                <div class="form-group"><label>フォーム設定JSON (form_config)</label><textarea id="field-form_config" rows="3" style="font-family: monospace; font-size: 0.8rem;"></textarea></div>
                <button class="btn-primary" onclick="saveAllSettings()">すべての設定を保存</button>
            </div>

            <div class="card" style="flex: 1;">
                <h3>② シフト枠 (shift_types)</h3>
                <div id="shift-list"></div>
                <button class="btn-secondary" style="width: 100%; margin-top: 10px;" onclick="addShiftRow()">+ 枠を追加</button>
                <p style="font-size: 0.8rem; color: #666; margin-top: 10px;">※保存ボタンを押すまで確定されません。<br>※並び順は上から順に保存されます。</p>
            </div>
        </div>
    </section>

    <section id="sec-qr-gen" style="display:none;">
        <h1>共有設定</h1>
        <div class="card">
            <input type="text" id="target-url" readonly style="width: 100%; padding: 8px; margin-bottom: 10px;">
            <button class="btn-primary" onclick="generateQR()">QRコードを生成</button>
            <div id="qrcode" style="margin-top:20px;"></div>
        </div>
    </section>
</div>

<script>
    const S_URL = 'https://vryxvtzrvmtyryugqzlp.supabase.co';
    const S_KEY = 'sb_publishable_RnuLQC0N_wYOrwLFQIf5Gg_O-g_bc2m';
    const client = supabase.createClient(S_URL, S_KEY);
    let currentProjectId = null;

    // --- 認証 ---
    async function login() {
        const { data, error } = await client.auth.signInWithPassword({
            email: document.getElementById('email').value,
            password: document.getElementById('password').value
        });
        if (error) alert(error.message); else location.reload();
    }
    async function logout() { await client.auth.signOut(); location.reload(); }

    function showSection(id) {
        document.querySelectorAll('section').forEach(s => s.style.display = 'none');
        document.getElementById('sec-' + id).style.display = 'block';
    }

    // --- 案件一覧 ---
    async function loadProjectData() {
        const { data: projects } = await client.from('projects').select('*').order('created_at', { ascending: false });
        const container = document.getElementById('project-list-container');
        container.innerHTML = projects.map(pj => `
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <div><strong>${pj.title_tag}</strong><br><small>${pj.h1_title}</small></div>
                <div>
                    <button class="btn-primary" onclick="selectProject('${pj.id}')">編集する</button>
                </div>
            </div>
        `).join('');
    }

    // --- 案件・シフト枠の読み込み ---
    async function selectProject(id) {
        currentProjectId = id;
        const { data: pj, error } = await client.from('projects').select('*').eq('id', id).single();
        
        if (error) {
            console.error("データ取得エラー:", error);
            return;
        }

        document.getElementById('current-pj-name').textContent = `現在編集中の案件: ${pj.title_tag || '未設定'}`;
        
        // 全項目をセット（データがNULLの場合は空文字にする）
        document.getElementById('field-title_tag').value = pj.title_tag || '';
        document.getElementById('field-h1_title').value = pj.h1_title || '';
        document.getElementById('field-msg_top').value = pj.msg_top || '';
        document.getElementById('field-msg_calendar').value = pj.msg_calendar || '';
        document.getElementById('field-msg_bottom').value = pj.msg_bottom || '';
        document.getElementById('field-msg_confirm').value = pj.msg_confirm || '';
        
        // JSON部分の安全な処理
        const configStr = pj.form_config ? JSON.stringify(pj.form_config, null, 2) : '{}';
        document.getElementById('field-form_config').value = configStr;

        // シフト枠の読み込み
        const { data: shifts } = await client.from('shift_types').select('*').eq('project_id', id).order('display_order');
        const shiftList = document.getElementById('shift-list');
        shiftList.innerHTML = '';
        if (shifts) shifts.forEach(s => addShiftRow(s.name, s.id));

        const baseUrl = window.location.href.split('dashboard.html')[0];
        document.getElementById('target-url').value = `${baseUrl}index.html?id=${id}`;

        showSection('edit-all');
    }

    // シフト入力行の追加
    function addShiftRow(name = '', id = null) {
        const div = document.createElement('div');
        div.className = 'shift-item';
        div.innerHTML = `
            <span style="cursor:grab">?</span>
            <input type="text" class="shift-name-input" value="${name}" placeholder="枠名 (例: 10:00-15:00)">
            <input type="hidden" class="shift-id-hidden" value="${id || ''}">
            <button class="btn-danger" onclick="this.parentElement.remove()">削除</button>
        `;
        document.getElementById('shift-list').appendChild(div);
    }

    // --- 保存処理 (案件+シフト枠) ---
    async function saveAllSettings() {
        if (!currentProjectId) return;

        // 1. プロジェクト情報の更新
        let configObj = {};
        try { configObj = JSON.parse(document.getElementById('field-form_config').value); } catch(e) { return alert("JSONの形式が正しくありません"); }

        const { error: pError } = await client.from('projects').update({
            title_tag: document.getElementById('field-title_tag').value,
            h1_title: document.getElementById('field-h1_title').value,
            msg_top: document.getElementById('field-msg_top').value,
            msg_calendar: document.getElementById('field-msg_calendar').value,
            msg_bottom: document.getElementById('field-msg_bottom').value,
            msg_confirm: document.getElementById('field-msg_confirm').value,
            form_config: configObj
        }).eq('id', currentProjectId);

        // 2. シフト枠の更新 (一度消して入れ直すのが確実ですが、ここでは名前と順序を更新)
        // 既存の枠を全削除して再登録する簡易方式
        await client.from('shift_types').delete().eq('project_id', currentProjectId);
        
        const shiftRows = document.querySelectorAll('.shift-item');
        const newShifts = Array.from(shiftRows).map((row, index) => ({
            project_id: currentProjectId,
            name: row.querySelector('.shift-name-input').value,
            display_order: index
        })).filter(s => s.name !== ''); // 空白は除外

        const { error: sError } = await client.from('shift_types').insert(newShifts);

        if (pError || sError) alert("保存エラーが発生しました");
        else {
            alert("すべての設定を保存しました");
            loadProjectData();
        }
    }

    async function createNewProject() {
        const name = prompt("新規案件の名称");
        if (!name) return;
        const { data, error } = await client.from('projects').insert([{ title_tag: name, h1_title: name }]).select();
        if (!error) loadProjectData();
    }

    function generateQR() {
        const url = document.getElementById('target-url').value;
        if(!url) return alert("案件を選択してください");
        document.getElementById('qrcode').innerHTML = "";
        new QRCode(document.getElementById("qrcode"), url);
    }

    window.onload = async () => {
        const { data: { session } } = await client.auth.getSession();
        if (session) {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('user-display').textContent = session.user.email;
            loadProjectData();
        }
    };
</script>
</body>
</html>
