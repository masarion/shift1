<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>シフト管理システム | 管理パネル</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { 
            --primary: #4361ee; 
            --sidebar-bg: #2b3a67; /* 少し明るめのネイビー */
            --active-bg: #4895ef; 
            --bg: #f8f9fc; 
            --text: #2b2d42; 
        }
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; color: var(--text); }
        
        /* ログイン画面 */
        #auth-container { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999; backdrop-filter: blur(5px); }
        .auth-box { width: 350px; padding: 40px; background: white; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        .auth-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        /* サイドバー */
        #sidebar { width: 260px; background: var(--sidebar-bg); color: white; padding: 25px 15px; flex-shrink: 0; display: flex; flex-direction: column; }
        #sidebar h3 { font-size: 1.2rem; margin-bottom: 30px; padding-left: 10px; border-left: 4px solid var(--active-bg); }
        .nav-item { padding: 14px 18px; cursor: pointer; border-radius: 10px; margin-bottom: 8px; transition: all 0.3s; display: flex; align-items: center; text-decoration: none; color: white; font-size: 0.95rem; }
        .nav-item:hover { background: rgba(255,255,255,0.1); }
        .nav-active { background: var(--active-bg) !important; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .nav-external { margin-top: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px; }
        
        /* メインコンテンツ */
        #main-content { flex-grow: 1; overflow-y: auto; padding: 40px; }
        h1 { font-size: 1.8rem; margin-bottom: 30px; }
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #edf2f7; }
        .card h3 { margin-top: 0; margin-bottom: 20px; font-size: 1.1rem; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
        
        /* フォーム要素 */
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: #4a5568; }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; box-sizing: border-box; font-size: 1rem; transition: border 0.2s; }
        .form-group input:focus, .form-group textarea:focus { border-color: var(--active-bg); outline: none; background: #fff; }
        
        /* シフト枠編集（ドラッグ対応） */
        .shift-item { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; background: #fff; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; cursor: default; }
        .drag-handle { cursor: grab; color: #cbd5e0; font-size: 1.2rem; display: flex; align-items: center; }
        .drag-handle:active { cursor: grabbing; }
        .shift-item input { flex-grow: 1; border: 1px solid transparent; padding: 8px; border-radius: 6px; }
        .shift-item input:focus { border-color: #e2e8f0; background: #f8fafc; }
        
        /* ボタン */
        button { padding: 12px 24px; border-radius: 10px; cursor: pointer; border: none; font-weight: bold; transition: all 0.2s; font-size: 0.95rem; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #3046d1; transform: translateY(-1px); }
        .btn-secondary { background: #f1f5f9; color: #475569; }
        .btn-danger { background: #fff5f5; color: #e53e3e; font-size: 0.8rem; padding: 6px 12px; }
        .btn-danger:hover { background: #fed7d7; }
        .btn-save-all { background: #059669; color: white; width: 100%; margin-top: 15px; font-size: 1.1rem; }
        .btn-save-all:hover { background: #047857; }

        .ghost { opacity: 0.4; background: #ebf4ff; border: 2px dashed var(--primary); }
    </style>
</head>
<body>

<div id="auth-container">
    <div class="auth-box">
        <h2 style="margin-top:0">管理者ログイン</h2>
        <input type="email" id="email" placeholder="メールアドレス">
        <input type="password" id="password" placeholder="パスワード">
        <button class="btn-primary" style="width:100%; margin-top:10px;" onclick="login()">ログイン</button>
    </div>
</div>

<div id="sidebar">
    <h3>シフト管理システム</h3>
    <div class="nav-item nav-active" onclick="showSection('projects')">案件一覧</div>
    <div class="nav-item" onclick="showSection('edit-all')">ページ内容・シフト枠</div>
    <div class="nav-item" onclick="showSection('qr-gen')">URL・QRコード</div>
    
    <div class="nav-external">
        <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); margin-bottom: 10px; padding-left: 10px;">データ確認</div>
        <a href="admin.html" target="_blank" class="nav-item" style="background: rgba(255,255,255,0.05);">
            シフト希望提出一覧 ↗
        </a>
    </div>

    <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
        <p id="user-display" style="font-size: 0.75rem; color: rgba(255,255,255,0.6); margin-bottom: 15px; overflow: hidden; text-overflow: ellipsis;"></p>
        <button onclick="logout()" style="background:transparent; color:rgba(255,255,255,0.6); border:1px solid rgba(255,255,255,0.2); width: 100%; padding: 8px;">ログアウト</button>
    </div>
</div>

<div id="main-content">
    <section id="sec-projects">
        <h1>案件一覧</h1>
        <div class="card" style="text-align: right;">
            <button class="btn-primary" onclick="createNewProject()">+ 新しい案件を作成</button>
        </div>
        <div id="project-list-container"></div>
    </section>

    <section id="sec-edit-all" style="display:none;">
        <h1>ページ内容とシフト枠の編集</h1>
        <div id="current-pj-name" style="margin-bottom:20px; padding: 10px 15px; background: #ebf4ff; border-radius: 8px; color: var(--primary); font-weight: bold; display: inline-block;"></div>
        
        <div style="display: flex; gap: 30px; align-items: flex-start;">
            <div class="card" style="flex: 1.2;">
                <h3>1. 表示テキストの設定</h3>
                <div class="form-group"><label>管理用タイトル</label><input type="text" id="field-title_tag"></div>
                <div class="form-group"><label>画面トップの見出し</label><input type="text" id="field-h1_title"></div>
                <div class="form-group"><label>冒頭のメッセージ</label><textarea id="field-msg_top" rows="3"></textarea></div>
                <div class="form-group"><label>カレンダー操作の説明</label><textarea id="field-msg_calendar" rows="3"></textarea></div>
                <div class="form-group"><label>入力フォームの説明</label><textarea id="field-msg_bottom" rows="3"></textarea></div>
                <div class="form-group"><label>確認画面の注意書き</label><textarea id="field-msg_confirm" rows="3"></textarea></div>
                
                <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
                    <label style="font-size: 0.8rem; color: #999;">システム設定用 (form_config)</label>
                    <textarea id="field-form_config" rows="2" style="font-family: monospace; font-size: 0.8rem; background: #f8fafc;"></textarea>
                </div>
            </div>

            <div class="card" style="flex: 0.8;">
                <h3>2. シフト枠の種類</h3>
                <p style="font-size: 0.85rem; color: #718096; margin-bottom: 15px;">
                    三本線マークをドラッグして並べ替えができます。
                </p>
                <div id="shift-list"></div>
                <button class="btn-secondary" style="width: 100%; margin-top: 15px; border: 2px dashed #cbd5e0;" onclick="addShiftRow()">+ 新しい枠を追加</button>
                
                <div style="margin-top: 40px; padding: 20px; background: #f0fdf4; border-radius: 12px; border: 1px solid #bbf7d0;">
                    <button class="btn-save-all" onclick="saveAllSettings()">すべての設定を保存する</button>
                    <p style="font-size: 0.75rem; color: #166534; text-align: center; margin-top: 10px;">
                        ※左側のテキストと右側のシフト枠が同時に保存されます。
                    </p>
                </div>
            </div>
        </div>
    </section>

    <section id="sec-qr-gen" style="display:none;">
        <h1>共有用URL・QRコード</h1>
        <div class="card" style="max-width: 500px;">
            <p style="font-weight: bold; margin-bottom: 10px;">スタッフ配布用URL</p>
            <input type="text" id="target-url" readonly style="width: 100%; padding: 12px; margin-bottom: 20px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; font-family: monospace;">
            <button class="btn-primary" style="width:100%" onclick="generateQR()">QRコードを作成</button>
            <div id="qrcode" style="margin-top:30px; display: flex; justify-content: center; background: white; padding: 20px; border: 1px solid #eee; border-radius: 10px;"></div>
        </div>
    </section>
</div>

<script>
    const S_URL = 'https://vryxvtzrvmtyryugqzlp.supabase.co';
    const S_KEY = 'sb_publishable_RnuLQC0N_wYOrwLFQIf5Gg_O-g_bc2m';
    const client = supabase.createClient(S_URL, S_KEY);
    let currentProjectId = null;
    let sortableInstance = null;

    // --- 認証 ---
    async function login() {
        const { data, error } = await client.auth.signInWithPassword({
            email: document.getElementById('email').value,
            password: document.getElementById('password').value
        });
        if (error) alert("ログインに失敗しました: " + error.message); 
        else location.reload();
    }
    async function logout() { await client.auth.signOut(); location.reload(); }

    function showSection(id) {
        document.querySelectorAll('section').forEach(s => s.style.display = 'none');
        document.getElementById('sec-' + id).style.display = 'block';
        
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('nav-active'));
        const activeNav = Array.from(document.querySelectorAll('.nav-item')).find(el => el.innerText.includes(id === 'projects' ? '案件一覧' : id === 'edit-all' ? 'ページ内容' : 'URL'));
        if(activeNav) activeNav.classList.add('nav-active');
    }

    // --- ドラッグ＆ドロップの初期化 ---
    function initSortable() {
        const el = document.getElementById('shift-list');
        if (sortableInstance) sortableInstance.destroy();
        sortableInstance = new Sortable(el, {
            handle: '.drag-handle',
            animation: 150,
            ghostClass: 'ghost'
        });
    }

    // --- 案件一覧の読み込み ---
    async function loadProjectData() {
        const { data: projects } = await client.from('projects').select('*').order('created_at', { ascending: false });
        const container = document.getElementById('project-list-container');
        container.innerHTML = projects.map(pj => `
            <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding: 20px 30px;">
                <div>
                    <div style="font-weight: bold; font-size: 1.1rem; color: var(--primary);">${pj.title_tag}</div>
                    <div style="color: #718096; font-size: 0.9rem; margin-top: 4px;">ID: ${pj.id}</div>
                </div>
                <button class="btn-primary" onclick="selectProject('${pj.id}')">この案件を編集する</button>
            </div>
        `).join('');
    }

    // --- 案件詳細・シフト枠の読み込み ---
    async function selectProject(id) {
        currentProjectId = id;
        const { data: pj } = await client.from('projects').select('*').eq('id', id).single();
        
        document.getElementById('current-pj-name').textContent = `編集中の案件: ${pj.title_tag}`;
        document.getElementById('field-title_tag').value = pj.title_tag || '';
        document.getElementById('field-h1_title').value = pj.h1_title || '';
        document.getElementById('field-msg_top').value = pj.msg_top || '';
        document.getElementById('field-msg_calendar').value = pj.msg_calendar || '';
        document.getElementById('field-msg_bottom').value = pj.msg_bottom || '';
        document.getElementById('field-msg_confirm').value = pj.msg_confirm || '';
        document.getElementById('field-form_config').value = JSON.stringify(pj.form_config || {}, null, 2);

        // シフト枠取得
        const { data: shifts } = await client.from('shift_types').select('*').eq('project_id', id).order('display_order');
        const shiftList = document.getElementById('shift-list');
        shiftList.innerHTML = '';
        if(shifts && shifts.length > 0) {
            shifts.forEach(s => addShiftRow(s.name));
        } else {
            addShiftRow('休み'); // 初期値
        }

        initSortable();

        // URL更新
        const baseUrl = window.location.href.split('dashboard.html')[0];
        document.getElementById('target-url').value = `${baseUrl}index.html?id=${id}`;

        showSection('edit-all');
    }

    // シフト入力行の追加
    function addShiftRow(name = '') {
        const div = document.createElement('div');
        div.className = 'shift-item';
        div.innerHTML = `
            <div class="drag-handle">☰</div>
            <input type="text" class="shift-name-input" value="${name}" placeholder="例: 9:00-18:00">
            <button class="btn-danger" onclick="this.parentElement.remove()">削除</button>
        `;
        document.getElementById('shift-list').appendChild(div);
    }

    // --- すべて一括保存 ---
    async function saveAllSettings() {
        if (!currentProjectId) return;

        // ボタンの状態変更
        const btn = document.querySelector('.btn-save-all');
        const originalText = btn.innerText;
        btn.innerText = "保存中...";
        btn.disabled = true;

        try {
            // 1. プロジェクト情報の更新
            let configObj = {};
            try { configObj = JSON.parse(document.getElementById('field-form_config').value || '{}'); } 
            catch(e) { throw new Error("設定用JSONの形式が正しくありません"); }

            const { error: pError } = await client.from('projects').update({
                title_tag: document.getElementById('field-title_tag').value,
                h1_title: document.getElementById('field-h1_title').value,
                msg_top: document.getElementById('field-msg_top').value,
                msg_calendar: document.getElementById('field-msg_calendar').value,
                msg_bottom: document.getElementById('field-msg_bottom').value,
                msg_confirm: document.getElementById('field-msg_confirm').value,
                form_config: configObj
            }).eq('id', currentProjectId);
            if (pError) throw pError;

            // 2. シフト枠の更新 (削除して再挿入)
            await client.from('shift_types').delete().eq('project_id', currentProjectId);
            
            const shiftRows = document.querySelectorAll('.shift-item');
            const newShifts = Array.from(shiftRows).map((row, index) => ({
                project_id: currentProjectId,
                name: row.querySelector('.shift-name-input').value,
                display_order: index // ここでドラッグ後の順番を上から順に0, 1, 2...と採番
            })).filter(s => s.name.trim() !== '');

            if(newShifts.length > 0) {
                const { error: sError } = await client.from('shift_types').insert(newShifts);
                if (sError) throw sError;
            }

            alert("すべての設定を正常に保存しました！");
            loadProjectData();
        } catch (err) {
            alert("エラーが発生しました: " + err.message);
        } finally {
            btn.innerText = originalText;
            btn.disabled = false;
        }
    }

    async function createNewProject() {
        const name = prompt("新しい案件の名前を入力してください");
        if (!name) return;
        const { error } = await client.from('projects').insert([{ title_tag: name, h1_title: '月のシフト希望' }]);
        if (error) alert("作成失敗: " + error.message);
        else loadProjectData();
    }

    function generateQR() {
        const url = document.getElementById('target-url').value;
        if(!url) return alert("案件を選択してください");
        document.getElementById('qrcode').innerHTML = "";
        new QRCode(document.getElementById("qrcode"), {
            text: url,
            width: 180,
            height: 180
        });
    }

    window.onload = async () => {
        const { data: { session } } = await client.auth.getSession();
        if (session) {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('user-display').textContent = `ログイン中: ${session.user.email}`;
            loadProjectData();
        }
    };
</script>
</body>
</html>
