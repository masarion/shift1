<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>シフト管理システム | 管理パネル</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { 
            --primary: #4361ee; 
            --sidebar-bg: #2b3a67; 
            --active-bg: #4895ef; 
            --bg: #f8f9fc; 
            --text: #2b2d42; 
            --danger: #e11d48;
            --success: #059669;
        }
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; color: var(--text); }
        
        /* サイドバー */
        #sidebar { width: 260px; background: var(--sidebar-bg); color: white; padding: 25px 15px; flex-shrink: 0; display: flex; flex-direction: column; overflow-y: auto; }
        .nav-item { padding: 14px 18px; cursor: pointer; border-radius: 10px; margin-bottom: 8px; transition: 0.3s; text-decoration: none; color: white; display: block; }
        .nav-active { background: var(--active-bg); font-weight: bold; }
        .nav-sub-list { margin-left: 15px; border-left: 2px solid rgba(255,255,255,0.2); padding-left: 10px; margin-bottom: 15px; }
        .nav-sub-item { padding: 6px 8px; cursor: pointer; color: rgba(255,255,255,0.7); font-size: 0.85rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .nav-sub-item:hover { color: white; background: rgba(255,255,255,0.1); border-radius: 4px; }

        /* メインエリア */
        #main-content { flex-grow: 1; overflow-y: auto; padding: 40px; }
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #edf2f7; margin-bottom: 25px; }
        
        /* 編集エリア */
        .edit-grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 25px; align-items: start; }
        .section-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid #f1f5f9; }
        .section-desc { font-size: 0.85rem; color: #64748b; margin-bottom: 20px; line-height: 1.5; }
        
        .input-group { margin-bottom: 15px; }
        .input-group label {
    display: block;
    font-size: 0.95rem;    /* 0.85から少し大きくしました */
    font-weight: bold;
    color: #334155;        /* #64748bから、より濃く視認性の高い色に変更しました */
    margin-bottom: 8px;    /* 6pxから少し広げて、入力欄との重なりをスッキリさせました */
}
        .input-group input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 0.95rem; box-sizing: border-box; }

        /* 共通ツールバーのスタイル */
        .floating-toolbar {
    position: sticky; top: 0; z-index: 100; background: #fff; padding: 10px; border: 1px solid #e2e8f0;
    border-radius: 10px; display: flex; gap: 10px; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
    margin-bottom: 20px;
    
    /* 追加：幅を制限し、はみ出さないようにする */
    max-width: fit-content; 
    flex-wrap: wrap;
}
        .toolbar-group { display: flex; gap: 5px; align-items: center; border-right: 1px solid #eee; padding-right: 10px; }
        .toolbar-icon-btn { background: white; border: 1px solid #ddd; padding: 5px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; }
        .toolbar-icon-btn:hover { background: #f1f5f9; }
        .color-bar { width: 16px; height: 3px; margin-top: 1px; }

        /* エディタ本体 */
        .rich-editor { min-height: 80px; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; background: white; outline: none; line-height: 1.5; }
        
        /* ボタン・アクション */
        .action-area { text-align: center; margin-top: 20px; padding: 30px 0; }
        .btn-save-fixed { background: var(--success); color: white; padding: 14px 60px; font-size: 1.1rem; border-radius: 12px; cursor: pointer; border: none; font-weight: bold; }
        .btn-preview { background: white; color: var(--primary); border: 1.5px solid var(--primary); padding: 8px 24px; border-radius: 8px; font-weight: bold; cursor: pointer; }
        
        /* シフト行 */
        .shift-row { display: flex; align-items: center; gap: 10px; background: #f8fafc; padding: 10px; border-radius: 10px; margin-bottom: 8px; border: 1px solid #e2e8f0; }
        .drag-handle { cursor: grab; color: #64748b; }

        /* QR・印刷系 */
        .btn-print { background: var(--primary); color: white; width: 100%; padding: 15px; font-size: 1rem; margin-top: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        .print-config { background: #f1f5f9; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; justify-content: center; }
        #print-preview-box { text-align: center; padding: 40px 20px; background: #fff; border: none; }

        /* 削除ボタンのホバー設定 */
.btn-delete-pj:hover {
    color: var(--danger) !important;
    text-shadow: 0 0 8px rgba(225, 29, 72, 0.3);
    font-weight: bold;
}

        .operation-guide {
    border: 1px solid #e2e8f0;
    background-color: #fcfcfc;
    padding: 12px 15px;
    margin-bottom: 15px;
    border-radius: 6px;
    font-size: 0.85rem;
    line-height: 1.6;
}
.guide-title {
    font-weight: bold;
    color: #475569;
    border-bottom: 1px solid #e2e8f0;
    margin-bottom: 8px;
    padding-bottom: 4px;
    display: inline-block;
}
.operation-guide ul {
    margin: 0;
    padding-left: 1.2rem;
    color: #64748b;
}
.operation-guide li {
    margin-bottom: 2px;
}
    </style>
</head>
<body>

<div id="sidebar">
    <h3 style="padding-left:10px;">管理システム</h3>
    <div class="nav-item nav-active" id="nav-projects" onclick="showSection('projects')">案件一覧</div>
    <div class="nav-item" id="nav-edit-all" onclick="showSection('edit-all')">ページ内容・シフト編集</div>
    <div class="nav-item" id="nav-qr" onclick="showSection('qr'); loadQRProjectList();">URL・QRコード作成</div>
    <div class="nav-item" id="nav-responses" onclick="showSection('responses')">送信データ（回答）確認</div>
    <div id="nav-response-list" class="nav-sub-list"></div>
</div>

<div id="main-content">
    <section id="sec-projects">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
            <h1>案件一覧</h1>
            <button class="btn-save-fixed" style="padding:10px 30px; font-size:1rem;" onclick="createNewProject()">+ 新規案件作成</button>
        </div>
        <div id="project-list">読み込み中...</div>
    </section>

    <section id="sec-edit-all" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
            <div>
                <h1 id="edit-page-title" style="margin-bottom:5px;">案件の編集</h1>
                <p style="font-size: 0.95rem; font-weight: bold; color: #334155; margin:0;">スタッフ用ページの編集ができます。</p>
            </div>
            <button class="btn-preview" onclick="openLivePreview()">スタッフ用ページを見る</button>
        </div>

        <div class="floating-toolbar">
            <div class="toolbar-group">
                <button class="toolbar-icon-btn" onclick="document.execCommand('bold')" title="太字">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path></svg>
                </button>
                <button class="toolbar-icon-btn" onclick="document.execCommand('underline')" title="下線">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3"></path><line x1="4" y1="21" x2="20" y2="21"></line></svg>
                </button>
            </div>
            <div class="toolbar-group">
                <select onchange="document.execCommand('fontSize', false, this.value); this.value='';" style="padding:4px; border-radius:4px; border:1px solid #ddd;">
                    <option value="">サイズ</option>
                    <option value="3">標準</option>
                    <option value="5">大</option>
                    <option value="7">特大</option>
                </select>
            </div>
            <div class="toolbar-group" style="position:relative; border-right:none;">
                <button onclick="const p=document.getElementById('edit-color-panel'); p.style.display=p.style.display==='grid'?'none':'grid'" style="background:white; border:1px solid #ddd; padding:4px 8px; border-radius:4px; cursor:pointer; display:flex; flex-direction:column; align-items:center;">
                    <span style="font-weight:bold; font-family:serif; font-size:14px; line-height:1;">A</span>
                    <div id="edit-color-bar" style="width:16px; height:3px; background:red;"></div>
                </button>
                <div id="edit-color-panel" style="display:none; position:absolute; top:100%; left:0; grid-template-columns:repeat(5, 1fr); gap:4px; background:white; padding:8px; border:1px solid #ccc; box-shadow:0 4px 10px rgba(0,0,0,0.1); z-index:1000; width:120px;">
    <div onmousedown="event.preventDefault(); applyColor('#000000')" style="width:20px; height:20px; background:#000; cursor:pointer; border:1px solid #ddd;"></div>
    <div onmousedown="event.preventDefault(); applyColor('#ff0000')" style="width:20px; height:20px; background:#ff0000; cursor:pointer; border:1px solid #ddd;"></div>
    <div onmousedown="event.preventDefault(); applyColor('#0000ff')" style="width:20px; height:20px; background:#0000ff; cursor:pointer; border:1px solid #ddd;"></div>
    <div onmousedown="event.preventDefault(); applyColor('#059669')" style="width:20px; height:20px; background:#059669; cursor:pointer; border:1px solid #ddd;"></div>
    <div onmousedown="event.preventDefault(); applyColor('#ff9900')" style="width:20px; height:20px; background:#ff9900; cursor:pointer; border:1px solid #ddd;"></div>
</div>
            </div>
        </div>

        <div class="edit-grid">
    <div class="card">
        <div class="section-title">1. 表示テキストの設定</div>

        <div class="operation-guide">
            <div class="guide-title">操作説明</div>
            <ul>
                <li><strong>編集：</strong> 各入力欄を書き換えられます。<strong>改行もそのまま反映されます。</strong></li>
                <li><strong>装飾：</strong> 文字を選択し、<strong>上のツールバー</strong>（Bや色など）で見た目を整えられます。</li>
                <li><strong>確定：</strong> 完了後、必ずページ最下部の<strong>「変更を保存して反映」</strong>を押してください。</li>
            </ul>
            <div style="margin-top: 8px; font-size: 0.8rem; color: #e11d48; border-top: 1px dashed #e2e8f0; padding-top: 8px;">
                ※最下部の「この案件を完全に削除する」は、案件自体が消えるためご注意ください。
            </div>
        </div>
        <div class="input-group">
    <label>
        案件名称（管理用） 
        <span style="font-weight: normal; color: #94a3b8; font-size: 0.75rem; margin-left: 8px;">
            ※スタッフがブックマークしたときの名称になります
        </span>
    </label>
    <input type="text" id="edit-title-tag">
</div>
                <div class="input-group">
    <label>
        画面トップの見出し
        <span style="display: block; font-weight: normal; color: #94a3b8; font-size: 0.75rem; margin-top: 2px; line-height: 1.4;">
            ※翌月が自動で表示されるのでそれ以降を編集してください<br>
            （例：「月のシフト」と入力すると「◯月のシフト」と表示されます。※◯月＝翌月です）
        </span>
    </label>
    <div id="edit-h1-title" class="rich-editor" contenteditable="true" style="margin-top: 8px;"></div>
</div>
                <div class="input-group"><label>冒頭メッセージ</label><div id="edit-msg-top" class="rich-editor" contenteditable="true"></div></div>
                <div class="input-group"><label>カレンダー操作説明</label><div id="edit-msg-calendar" class="rich-editor" contenteditable="true"></div></div>

<div class="input-group"><label>備考・その他希望欄の説明</label><div id="edit-msg-bottom" class="rich-editor" contenteditable="true"></div></div>

<div class="input-group"><label>確認画面の注意書き</label><div id="edit-msg-confirm" class="rich-editor" contenteditable="true"></div></div>
            </div>
            <div class="card">
                <div class="section-title">2. シフト枠の種類</div>
                <div class="operation-guide">
    <div class="guide-title">操作説明</div>
    <ul>
        <li><strong>並べ替え：</strong> 左のマークをドラッグすると並び替えができて、番号も同時に入れ替わります</li>
        <li><strong>テキスト：</strong> 各枠内をクリックして直接編集できます</li>
        <li><strong>削除：</strong> 右のゴミ箱アイコンから削除（確認ダイアログが表示されます）</li>
        <li><strong>確定：</strong> 完了後、必ずページ最下部の<strong>「変更を保存して反映」</strong>を押してください</li>
    </ul>
</div>
                <div id="shift-manager-list"></div>
                <button onclick="addShiftRow()" style="width:100%; padding:12px; margin-top:10px; background:#f1f5f9; border:1px dashed #cbd5e1; border-radius:8px; cursor:pointer;">+ 枠を追加</button>
            </div>
        </div>

        <div class="action-area">
            <button class="btn-save-fixed" onclick="saveSettings()">変更を保存して反映</button><br>
            <button class="btn-delete-pj" onclick="deleteCurrentProject()" style="background:none; border:none; color:#94a3b8; text-decoration:underline; cursor:pointer; margin-top:20px;">この案件を完全に削除する</button>
        </div>
    </section>

    <section id="sec-qr" style="display:none;">
        <h1>URL・QRコード作成</h1>
        <div class="edit-grid">
            <div class="card">
                <div class="section-title">案件を選択</div>
                <div id="qr-pj-list"></div>
            </div>
            <div class="card" id="preview-card-area">
                <div class="section-title">掲示用プレビュー</div>
                <div class="print-config" id="print-config-area" style="display:none;">
                    <span>対象月：</span>
                    <select id="print-month-select" onchange="updatePreviewMonth()">
                        <option value="◯月">指定なし</option>
                        <script>for(let i=1;i<=12;i++) document.write(`<option value="${i}月">${i}月</option>`);</script>
                    </select>
                </div>
                <div id="print-preview-box">
                    <p id="preview-month-display" style="font-size: 1.5rem; font-weight: bold; margin: 0; color: #4361ee;">◯月</p>
                    <h2 id="qr-pj-name" style="margin:5px 0 0 0;">案件を選択してください</h2>
                    <div id="qrcode-area" style="display:flex; justify-content:center; margin:25px 0;"></div>
                    <p id="qr-pj-url" style="font-size:0.8rem; color:#64748b; word-break:break-all;"></p>

<button id="btn-copy-url" onclick="copyToClipboard()" style="display:none; margin: 10px auto; padding: 6px 12px; background-color: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; border-radius: 6px; cursor: pointer; font-size: 0.8rem; align-items: center; gap: 5px;">
    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
    URLをコピー
</button>

                </div>
                <button id="btn-print-action" class="btn-print" style="display:none;" onclick="execPrint()">印刷用画面を開く</button>
            </div>
        </div>
    </section>

    <section id="sec-responses" style="display:none;">
        <h1>送信データ（回答）確認</h1>
        <div class="card"><p>左メニューの案件リストから確認したい案件を選択してください。</p></div>
    </section>
</div>

<script>
    const S_URL = 'https://vryxvtzrvmtyryugqzlp.supabase.co';
    const S_KEY = 'sb_publishable_RnuLQC0N_wYOrwLFQIf5Gg_O-g_bc2m';
    const client = supabase.createClient(S_URL, S_KEY);
    let currentId = null;
    let sortable = null;

    function applyColor(c) {
        document.execCommand('foreColor', false, c);
        document.getElementById('edit-color-bar').style.backgroundColor = c;
        document.getElementById('edit-color-panel').style.display = 'none';
    }

    function showSection(id) {
        document.querySelectorAll('section').forEach(s => s.style.display = 'none');
        document.getElementById('sec-' + id).style.display = 'block';
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('nav-active'));
        const navEl = document.getElementById('nav-' + id);
        if(navEl) navEl.classList.add('nav-active');
    }

    async function loadProjects() {
    try {
        const { data: pjs, error } = await client.from('projects').select('*').order('created_at', { ascending: false });
        
        if (error) throw error;

        // 1. メイン画面の案件一覧を更新
        const projectListEl = document.getElementById('project-list');
        if (pjs && pjs.length > 0) {
            projectListEl.innerHTML = pjs.map(p => `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding:15px 25px;">
                    <strong>${p.title_tag || '無題'}</strong>
                    <div style="display:flex; gap:10px;">
                        <button onclick="duplicateProject('${p.id}')" style="background:#f1f5f9; color:var(--text); border:1px solid #cbd5e1; padding:8px 15px; border-radius:8px; cursor:pointer; font-size:0.85rem;">コピーを作成</button>
                        <button onclick="editProject('${p.id}')" style="background:var(--primary); color:white; border:none; padding:8px 20px; border-radius:8px; cursor:pointer;">編集する</button>
                    </div>
                </div>
            `).join('');
        } else {
            projectListEl.innerHTML = '<div class="card">案件がありません。「新規案件作成」から追加してください。</div>';
        }

        // 2. サイドメニューの「送信データ確認」リストを更新
        const responseListEl = document.getElementById('nav-response-list');
        if (pjs && pjs.length > 0) {
            responseListEl.innerHTML = pjs.map(p => `
                <div class="nav-sub-item" onclick="location.href='admin.htm?id=${p.id}'">└ ${p.title_tag || '無題'}</div>
            `).join('');
        } else {
            responseListEl.innerHTML = '';
        }

    } catch (e) {
        console.error("プロジェクト読み込みエラー:", e);
        document.getElementById('project-list').innerHTML = "データの読み込みに失敗しました。";
    }
}

    // 案件のコピー（複製）処理
async function duplicateProject(sourceId) {
    if (!confirm("この案件の設定をコピーして新規作成しますか？")) return;

    try {
        // 1. 元の案件データを取得
        const { data: p, error: pErr } = await client.from('projects').select('*').eq('id', sourceId).single();
        if (pErr) throw pErr;

        // 2. 複製用の新しい案件を作成（IDは自動生成されるため除外）
        const { data: newP, error: insErr } = await client.from('projects').insert([{
            title_tag: p.title_tag + " のコピー",
            h1_title: p.h1_title,
            msg_top: p.msg_top,
            msg_calendar: p.msg_calendar,
            msg_confirm: p.msg_confirm
        }]).select().single();
        if (insErr) throw insErr;

        // 3. 元の案件に紐付くシフト枠を取得
        const { data: shifts, error: sErr } = await client.from('shift_types').select('*').eq('project_id', sourceId);
        if (sErr) throw sErr;

        // 4. シフト枠があれば、新しい案件IDに紐付けて一括保存
        if (shifts && shifts.length > 0) {
            const newShifts = shifts.map(s => ({
                project_id: newP.id,
                name: s.name,
                display_order: s.display_order
            }));
            const { error: insSErr } = await client.from('shift_types').insert(newShifts);
            if (insSErr) throw insSErr;
        }

        alert("コピーを作成しました。");
        loadProjects(); // 一覧を再読み込み
    } catch (e) {
        console.error(e);
        alert("コピーに失敗しました。");
    }
}

    async function editProject(id) {
        currentId = id;
        const { data: p } = await client.from('projects').select('*').eq('id', id).single();
        document.getElementById('edit-page-title').textContent = `「${p.title_tag}」の編集`;
        document.getElementById('edit-title-tag').value = p.title_tag || '';
        document.getElementById('edit-h1-title').innerHTML = p.h1_title || '';
        document.getElementById('edit-msg-top').innerHTML = p.msg_top || '';
        document.getElementById('edit-msg-calendar').innerHTML = p.msg_calendar || '';
        document.getElementById('edit-msg-bottom').innerHTML = p.msg_bottom || '';
        document.getElementById('edit-msg-confirm').innerHTML = p.msg_confirm || '';
        
        const { data: shifts } = await client.from('shift_types').select('*').eq('project_id', id).order('display_order');
        const container = document.getElementById('shift-manager-list');
        container.innerHTML = '';
        if(shifts && shifts.length > 0) shifts.forEach(s => addShiftRow(s.name));
        else addShiftRow('日勤');
        
        if(sortable) sortable.destroy();
        sortable = new Sortable(container, { 
            handle: '.drag-handle', 
            animation: 150,
            onEnd: function() {
                updateShiftNumbers(); // 並べ替えが終わったら番号を振り直す
            }
        });
        showSection('edit-all');
    }

    function updateShiftNumbers() {
    const rows = document.querySelectorAll('.shift-row');
    rows.forEach((row, index) => {
        // 各行の中にある「number-badge」というクラスの要素を探して数字を入れる
        const numBadge = row.querySelector('.number-badge');
        if (numBadge) {
            numBadge.textContent = index + 1;
        }
    });
}

    // シフト枠の削除を実行する関数
function deleteShiftRow(btn) {
    // 1. 確認ダイアログを表示
    const confirmed = confirm("このシフト枠を削除しますか？\n\n※まだこの時点ではデータベースからは削除されません。\n最下部の「変更を保存して反映」を押すと確定します。");

    // 2. 「OK」が押された場合のみ削除を実行
    if (confirmed) {
        btn.parentElement.remove(); // ボタンの親要素（shift-row全体）を消す
        updateShiftNumbers();       // 残った枠の番号を上から振り直す
    }
}

    function addShiftRow(val = '') {
    const div = document.createElement('div');
    div.className = 'shift-row';
    // 行の先頭に <span class="number-badge"></span> を追加
    div.innerHTML = `
        <div class="drag-handle" style="cursor:grab; display:flex; align-items:center; color:#94a3b8;">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="9" cy="12" r="1"></circle>
        <circle cx="9" cy="5" r="1"></circle>
        <circle cx="9" cy="19" r="1"></circle>
        <circle cx="15" cy="12" r="1"></circle>
        <circle cx="15" cy="5" r="1"></circle>
        <circle cx="15" cy="19" r="1"></circle>
    </svg>
</div>
        <span class="number-badge" style="font-weight:bold; margin:0 10px; color:#64748b; min-width:20px;"></span>
        <input type="text" value="${val}" style="flex:1; border:none; background:transparent;">
        <button onclick="deleteShiftRow(this)" style="background:none; border:none; cursor:pointer; color:#94a3b8; padding:5px; transition:0.2s;" onmouseover="this.style.color='#e11d48'" onmouseout="this.style.color='#94a3b8'">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
        <line x1="10" y1="11" x2="10" y2="17"></line>
        <line x1="14" y1="11" x2="14" y2="17"></line>
    </svg>
</button>`;
    
    document.getElementById('shift-manager-list').appendChild(div);
    
    // 追加した後に番号を更新
    updateShiftNumbers();
}

    async function saveSettings() {
        if(!currentId) return;
        await client.from('projects').update({
            title_tag: document.getElementById('edit-title-tag').value,
            h1_title: document.getElementById('edit-h1-title').innerHTML,
            msg_top: document.getElementById('edit-msg-top').innerHTML,
            msg_calendar: document.getElementById('edit-msg-calendar').innerHTML,
            msg_bottom: document.getElementById('edit-msg-bottom').innerHTML,
            msg_confirm: document.getElementById('edit-msg-confirm').innerHTML
        }).eq('id', currentId);
        
        await client.from('shift_types').delete().eq('project_id', currentId);
        const shifts = Array.from(document.querySelectorAll('.shift-row input')).map((el, i) => ({
            project_id: currentId, name: el.value, display_order: i
        })).filter(s => s.name !== '');
        await client.from('shift_types').insert(shifts);
        alert("保存しました");
        loadProjects();
    }

    function openLivePreview() {
        if(!currentId) return;
        window.open(window.location.href.split('dashboard.htm')[0] + 'index.htm?id=' + currentId + '&preview=1', '_blank');
    }

    async function loadQRProjectList() {
        const { data: pjs } = await client.from('projects').select('*').order('created_at', { ascending: false });
        document.getElementById('qr-pj-list').innerHTML = pjs.map(p => `
            <div onclick="generateQR('${p.id}', '${p.title_tag}')" style="padding:15px; border:1px solid #eee; border-radius:10px; margin-bottom:10px; cursor:pointer; background:#fff;"><strong>${p.title_tag}</strong></div>
        `).join('');
    }

    function generateQR(id, title) {
        const url = window.location.href.split('dashboard.htm')[0] + 'index.htm?id=' + id;
        document.getElementById('qr-pj-name').textContent = title;
        document.getElementById('qr-pj-url').textContent = url;
        document.getElementById('qrcode-area').innerHTML = '';
        new QRCode(document.getElementById('qrcode-area'), { text: url, width: 200, height: 200 });
        document.getElementById('btn-print-action').style.display = 'block';
        document.getElementById('print-config-area').style.display = 'flex';
    }

    function updatePreviewMonth() {
        document.getElementById('preview-month-display').textContent = document.getElementById('print-month-select').value;
    }

    // URLをクリップボードにコピーする関数
function copyToClipboard() {
    const urlText = document.getElementById('qr-pj-url').innerText;
    if (!urlText) return;

    navigator.clipboard.writeText(urlText).then(() => {
        const btn = document.getElementById('btn-copy-url');
        const originalContent = btn.innerHTML;
        
        // 見た目のフィードバック
        btn.innerHTML = '✅ コピーしました！';
        btn.style.backgroundColor = '#d1fae5';
        btn.style.color = '#065f46';
        
        setTimeout(() => {
            btn.innerHTML = originalContent;
            btn.style.backgroundColor = '#f1f5f9';
            btn.style.color = '#475569';
        }, 2000);
    });
}

    function execPrint() {
        const month = document.getElementById('preview-month-display').textContent;
        const title = document.getElementById('qr-pj-name').textContent;
        const qrData = document.getElementById('qr-pj-url').textContent;
        const win = window.open('', '_blank');
        win.document.write(`<html><head><title>印刷</title>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>
            <style>
                @page { margin: 0; }
                body { text-align: center; font-family: sans-serif; background: #f0f0f0; margin: 0; padding: 0; }
                .no-print { padding: 15px; background: #fff; border-bottom: 1px solid #ddd; position: sticky; top:0; z-index:100; display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap; }
                .btn-exec { background: #4361ee; color: white; padding: 10px 30px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
                .print-canvas { background: white; display: inline-block; padding: 100px 60px; min-height: 100vh; width: 210mm; box-sizing: border-box; }
                .editable { cursor: pointer; border: 1px dashed transparent; outline: none; }
                .toolbar-icon-btn { background: white; border: 1px solid #ddd; padding: 5px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; }
                @media print { .no-print { display: none; } body { background: white; } }
            </style>
        </head><body>
            <p class="no-print" style="color: #64748b; font-size: 0.9rem; margin-top: 15px;">テキストをクリックして編集できます。よろしければ「印刷を実行」してください</p>
            <div class="no-print" style="margin-bottom:20px;">
                <button class="toolbar-icon-btn" onclick="document.execCommand('bold')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M6 4h8a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path><path d="M6 12h9a4 4 0 0 1 4 4 4 4 0 0 1-4 4H6z"></path></svg></button>
                <button class="toolbar-icon-btn" onclick="document.execCommand('underline')"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 3v7a6 6 0 0 0 6 6 6 6 0 0 0 6-6V3"></path><line x1="4" y1="21" x2="20" y2="21"></line></svg></button>
                <div style="display:flex; align-items:center; border:1px solid #ddd; border-radius:4px; background:#f8f9fa; padding:2px;">
                    <button onclick="changeFS('smaller')" style="border:none; background:none; cursor:pointer; padding:2px 8px; font-weight:bold;">-</button>
                    <select id="fs-select" onchange="document.execCommand('fontSize', false, this.value)" style="border:none; background:none; font-size:13px; width:60px;">
                        <option value="3">100%</option><option value="4">120%</option><option value="5">150%</option><option value="6">200%</option><option value="7">300%</option>
                    </select>
                    <button onclick="changeFS('bigger')" style="border:none; background:none; cursor:pointer; padding:2px 8px; font-weight:bold;">+</button>
                </div>
                <div style="position:relative;">
                    <button onclick="const p=document.getElementById('p-col'); p.style.display=p.style.display==='grid'?'none':'grid'" style="background:white; border:1px solid #ddd; padding:4px 8px; border-radius:4px; cursor:pointer; display:flex; flex-direction:column; align-items:center;">
                        <span style="font-weight:bold; font-size:15px; line-height:1;">A</span><div id="p-bar" style="width:16px; height:3px; background:red;"></div>
                    </button>
<div id="p-col" style="display:none; position:absolute; top:100%; left:0; grid-template-columns:repeat(5, 1fr); gap:4px; background:white; padding:8px; border:1px solid #ccc; width:120px; z-index:1000;">
    <div onmousedown="event.preventDefault(); document.execCommand('foreColor', false, '#000'); document.getElementById('p-bar').style.backgroundColor='#000'; document.getElementById('p-col').style.display='none'" style="width:20px; height:20px; background:#000; cursor:pointer; border:1px solid #ddd;"></div>
    <div onmousedown="event.preventDefault(); document.execCommand('foreColor', false, '#ff0000'); document.getElementById('p-bar').style.backgroundColor='#ff0000'; document.getElementById('p-col').style.display='none'" style="width:20px; height:20px; background:#ff0000; cursor:pointer; border:1px solid #ddd;"></div>
    <div onmousedown="event.preventDefault(); document.execCommand('foreColor', false, '#0000ff'); document.getElementById('p-bar').style.backgroundColor='#0000ff'; document.getElementById('p-col').style.display='none'" style="width:20px; height:20px; background:#0000ff; cursor:pointer; border:1px solid #ddd;"></div>
    <div onmousedown="event.preventDefault(); document.execCommand('foreColor', false, '#059669'); document.getElementById('p-bar').style.backgroundColor='#059669'; document.getElementById('p-col').style.display='none'" style="width:20px; height:20px; background:#059669; cursor:pointer; border:1px solid #ddd;"></div>
    <div onmousedown="event.preventDefault(); document.execCommand('foreColor', false, '#ff9900'); document.getElementById('p-bar').style.backgroundColor='#ff9900'; document.getElementById('p-col').style.display='none'" style="width:20px; height:20px; background:#ff9900; cursor:pointer; border:1px solid #ddd;"></div>
</div>
                </div>
                <button class="btn-exec" onclick="window.print()">印刷を実行</button>
                <button onclick="window.close()" style="padding:8px 15px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer;">閉じる</button>
            </div>
            <script>
                function changeFS(dir) {
                    const s = document.getElementById('fs-select');
                    if(dir==='bigger' && s.selectedIndex < s.options.length-1) s.selectedIndex++;
                    else if(dir==='smaller' && s.selectedIndex > 0) s.selectedIndex--;
                    document.execCommand('fontSize', false, s.value);
                }
            <\/script>
            <div class="print-canvas">
                <p class="editable" style="font-size:4rem; font-weight:bold; margin:0;" contenteditable="true">${month}</p>
                <h1 class="editable" style="font-size:2.8rem; margin:20px 0 60px 0;" contenteditable="true">${title}</h1>
                <div id="qrcode" style="display:flex; justify-content:center; margin:30px auto;"></div>
                <p class="editable" style="font-size:1.8rem; font-weight:bold;" contenteditable="true">シフト希望の提出はこちらから</p>
            </div>
            <script>new QRCode(document.getElementById("qrcode"), { text: "${qrData}", width: 400, height: 400 });<\/script>
        </body></html>`);
        win.document.close();
    }

    async function createNewProject() {
        const name = prompt("案件名を入力");
        if(name) { await client.from('projects').insert([{ title_tag: name, h1_title: name }]); loadProjects(); }
    }
    
    // 案件削除の実行関数
async function deleteCurrentProject() {
    if (!currentId) return;

    const confirmed = confirm(
        "【警告】この案件を削除すると、設定内容および関連するシフトデータがデータベースから完全に消去されます。復元はできません。\n\n本当に削除しますか？"
    );

    if (confirmed) {
        try {
            // 関連データの削除（外部キー制約がある場合はshift_types等から削除）
            await client.from('shift_types').delete().eq('project_id', currentId);
            const { error } = await client.from('projects').delete().eq('id', currentId);

            if (error) throw error;

            alert("案件を削除しました。");
            location.reload(); // 一覧に戻るためにリロード
        } catch (e) {
            console.error(e);
            alert("削除に失敗しました。");
        }
    }
}

    window.onload = loadProjects;
</script>
</body>
</html>











