<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>シフト提出一覧 | 管理パネル</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --primary: #4361ee; 
            --bg: #f8f9fc; 
            --text: #2b2d42; 
            --danger: #e11d48;
            --success: #059669;
        }
        body { font-family: "Helvetica Neue", Arial, sans-serif; background: var(--bg); margin: 0; padding: 30px; color: var(--text); }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #e2e8f0; padding-bottom: 20px; }
        .project-info { display: flex; align-items: center; gap: 15px; }
        h1 { margin: 0; font-size: 1.4rem; color: #1e293b; }
        .project-badge { background: var(--primary); color: white; padding: 4px 12px; border-radius: 6px; font-size: 0.9rem; font-weight: bold; }
        
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f8fafc; color: #64748b; font-weight: bold; text-align: left; padding: 15px; border-bottom: 2px solid #edf2f7; font-size: 0.85rem; }
        td { padding: 15px; border-bottom: 1px solid #edf2f7; vertical-align: top; font-size: 0.95rem; }
        
        .staff-name { font-weight: bold; color: #1e293b; font-size: 1.1rem; }
        .submit-date { font-size: 0.75rem; color: #94a3b8; display: block; margin-top: 4px; }
        
        /* シフトデータの簡易表示 */
        .shift-cell { line-height: 1.6; color: #475569; font-size: 0.9rem; }
        .shift-day-item { display: inline-block; background: #f1f5f9; padding: 2px 8px; border-radius: 4px; margin: 2px; font-size: 0.8rem; }
        
        .btn-delete { color: var(--danger); background: #fff1f2; border: 1px solid #fecdd3; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: bold; transition: 0.2s; }
        .btn-delete:hover { background: var(--danger); color: white; }
        
        .no-data { text-align: center; padding: 60px; color: #94a3b8; }
        .loading { text-align: center; padding: 40px; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<div id="admin-app">
    <div class="header">
        <div class="project-info">
            <h1>提出データ確認</h1>
            <span id="project-name" class="project-badge">読み込み中...</span>
        </div>
        <button onclick="window.close()" style="background:#64748b; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;">× 閉じる</button>
    </div>

    <div id="content" class="card">
        <div class="loading">データを取得しています...</div>
    </div>
</div>

<script>
    const S_URL = 'https://vryxvtzrvmtyryugqzlp.supabase.co';
    const S_KEY = 'sb_publishable_RnuLQC0N_wYOrwLFQIf5Gg_O-g_bc2m';
    const client = supabase.createClient(S_URL, S_KEY);

    async function init() {
        const params = new URLSearchParams(window.location.search);
        const projectId = params.get('id');

        if (!projectId) {
            document.getElementById('content').innerHTML = '<div class="no-data">案件IDが指定されていません。</div>';
            return;
        }

        // 1. 案件情報の取得
        const { data: project } = await client.from('projects').select('title_tag').eq('id', projectId).single();
        if (project) {
            document.getElementById('project-name').textContent = project.title_tag;
            document.title = `提出一覧: ${project.title_tag}`;
        }

        fetchSubmissions(projectId);
    }

    // データの取得と表示
    async function fetchSubmissions(projectId) {
        const { data: submissions, error } = await client
            .from('submissions')
            .select('*')
            .eq('project_id', projectId)
            .order('created_at', { ascending: false });

        if (error) {
            document.getElementById('content').innerHTML = `<div class="no-data">エラーが発生しました: ${error.message}</div>`;
            return;
        }

        if (!submissions || submissions.length === 0) {
            document.getElementById('content').innerHTML = '<div class="no-data">まだ提出されたデータはありません。</div>';
            return;
        }

        renderTable(submissions, projectId);
    }

    // テーブルの描画
    function renderTable(data, projectId) {
        let html = `
            <table>
                <thead>
                    <tr>
                        <th style="width: 200px;">提出者 / 日時</th>
                        <th>提出内容 (日付: 枠)</th>
                        <th style="width: 80px;">操作</th>
                    </tr>
                </thead>
                <tbody>
        `;

        data.forEach(item => {
            const dateStr = new Date(item.created_at).toLocaleString('ja-JP', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
            
            // シフトデータのパース (JSON形式を想定)
            let shiftDisplay = "";
            try {
                const shifts = JSON.parse(item.shift_data);
                // 日付順に並び替えて表示
                Object.keys(shifts).sort().forEach(day => {
                    shiftDisplay += `<span class="shift-day-item"><strong>${day}日</strong>: ${shifts[day]}</span>`;
                });
            } catch(e) {
                shiftDisplay = item.shift_data; // JSONでない場合はそのまま表示
            }

            html += `
                <tr>
                    <td>
                        <div class="staff-name">${item.staff_name}</div>
                        <span class="submit-date">${dateStr} 提出</span>
                    </td>
                    <td class="shift-cell">
                        ${shiftDisplay}
                        ${item.memo ? `<div style="margin-top:10px; color:#64748b; font-size:0.85rem; border-top:1px dashed #eee; padding-top:5px;">備考: ${item.memo}</div>` : ''}
                    </td>
                    <td>
                        <button class="btn-delete" onclick="deleteSubmission('${item.id}', '${item.staff_name}', '${projectId}')">削除</button>
                    </td>
                </tr>
            `;
        });

        html += `</tbody></table>`;
        document.getElementById('content').innerHTML = html;
    }

    // 特定の提出データを削除する機能
    async function deleteSubmission(id, name, projectId) {
        if (!confirm(`【確認】\n${name}さんのこの提出データを削除しますか？\n一度消すと元に戻せません。`)) return;

        const { error } = await client.from('submissions').delete().eq('id', id);

        if (error) {
            alert("削除に失敗しました: " + error.message);
        } else {
            alert("削除完了しました。");
            fetchSubmissions(projectId); // リストを再読み込み
        }
    }

    init();
</script>
</body>
</html>
