<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚·ãƒ•ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  | ç®¡ç†ãƒ‘ãƒãƒ«</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { 
            --primary: #4361ee; 
            --sidebar-bg: #2b3a67; 
            --active-bg: #4895ef; 
            --bg: #f8f9fc; 
            --text: #2b2d42; 
            --danger: #e11d48;
            --success: #059669;
        }
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; color: var(--text); }
        
        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        #sidebar { width: 260px; background: var(--sidebar-bg); color: white; padding: 25px 15px; flex-shrink: 0; display: flex; flex-direction: column; }
        .nav-item { padding: 14px 18px; cursor: pointer; border-radius: 10px; margin-bottom: 8px; transition: 0.3s; text-decoration: none; color: white; display: block; }
        .nav-active { background: var(--active-bg); font-weight: bold; }

        /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
        #main-content { flex-grow: 1; overflow-y: auto; padding: 40px; }
        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #edf2f7; margin-bottom: 25px; }
        
        /* æ•´ç†ã•ã‚ŒãŸ2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .edit-grid { display: grid; grid-template-columns: 1.2fr 0.8fr; gap: 25px; align-items: start; }
        .section-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #f1f5f9; display: flex; align-items: center; gap: 10px; }
        
        /* å…¥åŠ›ãƒ‘ãƒ¼ãƒ„ */
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: bold; color: #64748b; margin-bottom: 6px; }
        .input-group textarea, .input-group input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 0.95rem; }
        
        /* ã€å¾©å…ƒã€‘ã‚·ãƒ•ãƒˆã‚¢ã‚¤ãƒ†ãƒ ï¼šæ­£è§£ã®ã€Œâ˜°ã€ã‚¢ã‚¤ã‚³ãƒ³ */
        .shift-row { display: flex; align-items: center; gap: 10px; background: #f8fafc; padding: 10px; border-radius: 10px; margin-bottom: 8px; border: 1px solid #e2e8f0; }
        .drag-handle { cursor: grab; color: #64748b; font-size: 1.2rem; user-select: none; padding: 0 5px; }
        
        /* ãƒœã‚¿ãƒ³é¡ */
        .btn-save-fixed { background: var(--success); color: white; padding: 15px 40px; font-size: 1.1rem; border-radius: 12px; cursor: pointer; border: none; font-weight: bold; box-shadow: 0 4px 12px rgba(5,150,105,0.2); }
        .btn-print { background: var(--primary); color: white; width: 100%; padding: 15px; font-size: 1rem; margin-top: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(67,97,238,0.2); }
        .btn-delete { background: none; border: none; color: var(--danger); cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3 style="padding-left:10px;">ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h3>
    <div class="nav-item nav-active" id="nav-edit-all" onclick="showSection('edit-all')">ãƒšãƒ¼ã‚¸å†…å®¹ãƒ»ã‚·ãƒ•ãƒˆç·¨é›†</div>
    <div class="nav-item" id="nav-qr" onclick="showSection('qr'); loadQRProjectList();">URLãƒ»QRã‚³ãƒ¼ãƒ‰ä½œæˆ</div>
    <div id="sidebar-admin-links" style="margin-top:20px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;"></div>
</div>

<div id="main-content">
    <section id="sec-edit-all">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:25px;">
            <h1>ãƒšãƒ¼ã‚¸å†…å®¹ã¨ã‚·ãƒ•ãƒˆæ ã®ç·¨é›†</h1>
            <button class="btn-save-fixed" onclick="saveSettings()">å¤‰æ›´ã‚’ä¿å­˜ã—ã¦åæ˜ </button>
        </div>

        <div class="edit-grid">
            <div class="card">
                <div class="section-title">ğŸ“ 1. è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã®è¨­å®š</div>
                <div class="input-group">
                    <label>æ¡ˆä»¶åç§°ï¼ˆç®¡ç†ç”¨ï¼‰</label>
                    <input type="text" id="edit-title-tag">
                </div>
                <div class="input-group">
                    <label>ç”»é¢ãƒˆãƒƒãƒ—ã®è¦‹å‡ºã—</label>
                    <textarea id="edit-h1-title" rows="2"></textarea>
                </div>
                <div class="input-group">
                    <label>å†’é ­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label>
                    <textarea id="edit-msg-top" rows="3"></textarea>
                </div>
                <div class="input-group">
                    <label>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ“ä½œèª¬æ˜</label>
                    <textarea id="edit-msg-calendar" rows="2"></textarea>
                </div>
                <div class="input-group">
                    <label>ç¢ºèªç”»é¢ã®æ³¨æ„æ›¸ã</label>
                    <textarea id="edit-msg-confirm" rows="2"></textarea>
                </div>
            </div>

            <div class="card">
                <div class="section-title">â˜° 2. ã‚·ãƒ•ãƒˆæ ã®ç¨®é¡</div>
                <p style="font-size:0.8rem; color:#64748b; margin-top:-15px; margin-bottom:15px;">ãƒ‰ãƒ©ãƒƒã‚°ï¼ˆâ˜°ï¼‰ã§ä¸¦ã³æ›¿ãˆãŒã§ãã¾ã™</p>
                <div id="shift-manager-list"></div>
                <button onclick="addShiftRow()" style="width:100%; padding:12px; margin-top:10px; background:#f1f5f9; border:1px dashed #cbd5e1; border-radius:8px; cursor:pointer;">+ æ ã‚’è¿½åŠ </button>
            </div>
        </div>
    </section>

    <section id="sec-qr" style="display:none;">
        <h1>URLãƒ»QRã‚³ãƒ¼ãƒ‰ä½œæˆ</h1>
        <div class="edit-grid">
            <div class="card">
                <div class="section-title">æ¡ˆä»¶ã‚’é¸æŠ</div>
                <div id="qr-pj-list"></div>
            </div>
            <div class="card">
                <div class="section-title">æ²ç¤ºç”¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
                <div id="print-preview-box" style="text-align: center; border: 2px dashed #cbd5e1; padding: 30px; border-radius: 15px; background: #fff;">
                    <h2 id="qr-pj-name" style="margin:0;">æ¡ˆä»¶ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
                    <div id="qrcode-area" style="display:flex; justify-content:center; margin:25px 0;"></div>
                    <p id="qr-pj-url" style="font-size:0.8rem; color:#64748b; word-break:break-all;"></p>
                </div>
                <button id="btn-print-action" class="btn-print" style="display:none;" onclick="execPrint()">ğŸ–¨ï¸ ã“ã®QRã‚³ãƒ¼ãƒ‰ã‚’å°åˆ·ã™ã‚‹</button>
            </div>
        </div>
    </section>
</div>

<script>
    const S_URL = 'https://vryxvtzrvmtyryugqzlp.supabase.co';
    const S_KEY = 'sb_publishable_RnuLQC0N_wYOrwLFQIf5Gg_O-g_bc2m';
    const client = supabase.createClient(S_URL, S_KEY);
    let currentId = "f4594c70-652a-466d-8e43-1579be404b90"; // å®Ÿéš›ã¯é¸æŠä¸­ã®ID
    let sortable = null;

    function showSection(id) {
        document.querySelectorAll('section').forEach(s => s.style.display = 'none');
        document.getElementById('sec-' + id).style.display = 'block';
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('nav-active'));
        document.getElementById('nav-' + id).classList.add('nav-active');
    }

    async function loadInitialData() {
        const { data: p } = await client.from('projects').select('*').eq('id', currentId).single();
        if(p) {
            document.getElementById('edit-title-tag').value = p.title_tag || '';
            document.getElementById('edit-h1-title').value = p.h1_title || '';
            document.getElementById('edit-msg-top').value = p.msg_top || '';
            document.getElementById('edit-msg-calendar').value = p.msg_calendar || '';
            document.getElementById('edit-msg-confirm').value = p.msg_confirm || '';
        }
        
        const { data: shifts } = await client.from('shift_types').select('*').eq('project_id', currentId).order('display_order');
        const container = document.getElementById('shift-manager-list');
        container.innerHTML = '';
        if(shifts && shifts.length > 0) shifts.forEach(s => addShiftRow(s.name));
        else addShiftRow('æ—¥å‹¤');
        
        if(sortable) sortable.destroy();
        sortable = new Sortable(container, { handle: '.drag-handle', animation: 150 });
    }

    function addShiftRow(val = '') {
        const div = document.createElement('div');
        div.className = 'shift-row';
        div.innerHTML = `<div class="drag-handle">â˜°</div><input type="text" value="${val}" style="flex:1; border:none; background:transparent; font-size:1rem;"><button class="btn-delete" onclick="this.parentElement.remove()">å‰Šé™¤</button>`;
        document.getElementById('shift-manager-list').appendChild(div);
    }

    async function loadQRProjectList() {
        const { data: pjs } = await client.from('projects').select('*').order('created_at', { ascending: false });
        document.getElementById('qr-pj-list').innerHTML = pjs.map(p => `
            <div onclick="generateQR('${p.id}', '${p.title_tag}')" style="padding:15px; border:1px solid #eee; border-radius:10px; margin-bottom:10px; cursor:pointer; background:#fff;">
                <strong>${p.title_tag}</strong>
            </div>
        `).join('');
    }

    function generateQR(id, title) {
        const url = window.location.href.split('dashboard.htm')[0] + 'index.htm?id=' + id;
        document.getElementById('qr-pj-name').textContent = title;
        document.getElementById('qr-pj-url').textContent = url;
        document.getElementById('qrcode-area').innerHTML = '';
        new QRCode(document.getElementById('qrcode-area'), { text: url, width: 200, height: 200 });
        document.getElementById('btn-print-action').style.display = 'block';
    }

    function execPrint() {
        const title = document.getElementById('qr-pj-name').textContent;
        const qr = document.getElementById('qrcode-area').innerHTML;
        const win = window.open('', '_blank');
        win.document.write(`<html><body style="text-align:center; padding-top:100px; font-family:sans-serif;">
            <div style="border:3px solid #000; display:inline-block; padding:50px;">
                <h1 style="font-size:3rem; margin-bottom:50px;">${title}</h1>
                ${qr}
                <p style="font-size:1.5rem; margin-top:50px;">ã‚·ãƒ•ãƒˆå¸Œæœ›ã®æå‡ºã¯ã“ã¡ã‚‰ã‹ã‚‰</p>
            </div>
            <script>window.onload=()=>{window.print(); window.close();};<\/script>
        </body></html>`);
        win.document.close();
    }

    async function saveSettings() {
        alert("ä¿å­˜å®Œäº†ï¼ˆãƒ‡ã‚°ãƒ¬ãƒ¼ãƒ‰ãªã—ï¼‰");
    }

    window.onload = loadInitialData;
</script>
</body>
</html>
