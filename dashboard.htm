<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚·ãƒ•ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  | ç®¡ç†ãƒ‘ãƒãƒ«</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { 
            --primary: #4361ee; 
            --sidebar-bg: #2b3a67; 
            --active-bg: #4895ef; 
            --bg: #f8f9fc; 
            --text: #2b2d42; 
            --danger: #e11d48;
            --success: #059669;
        }
        body { font-family: "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; color: var(--text); overflow: hidden; }
        
        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        #sidebar { width: 280px; background: var(--sidebar-bg); color: white; padding: 25px 15px; flex-shrink: 0; display: flex; flex-direction: column; overflow-y: auto; }
        #sidebar h3 { font-size: 1.1rem; margin-bottom: 25px; padding-left: 10px; border-left: 4px solid var(--active-bg); }
        .sidebar-label { font-size: 0.75rem; color: rgba(255,255,255,0.5); margin: 20px 0 10px 10px; text-transform: uppercase; letter-spacing: 1px; }
        
        .nav-item { padding: 12px 15px; cursor: pointer; border-radius: 8px; margin-bottom: 5px; transition: all 0.2s; display: flex; align-items: center; text-decoration: none; color: rgba(255,255,255,0.8); font-size: 0.9rem; }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-active { background: var(--active-bg) !important; color: white !important; font-weight: bold; }
        
        /* ãƒ‡ãƒ¼ã‚¿ç¢ºèªç”¨ãƒªãƒ³ã‚¯ã®ç‰¹æ®Šã‚¹ã‚¿ã‚¤ãƒ« */
        .admin-link { font-size: 0.85rem; padding-left: 20px; color: #a5b4fc; }
        .admin-link::before { content: "ğŸ“Š"; margin-right: 8px; font-size: 0.8rem; }
        .admin-link:hover { color: #fff; background: rgba(72, 149, 239, 0.2); }

        /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
        #main-content { flex-grow: 1; overflow-y: auto; padding: 40px; }
        h1 { font-size: 1.8rem; margin-bottom: 30px; }
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #edf2f7; }
        
        /* ãƒœã‚¿ãƒ³é¡ */
        button { padding: 12px 24px; border-radius: 10px; cursor: pointer; border: none; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-save-all { background: var(--success); color: white; width: 100%; max-width: 600px; padding: 18px; font-size: 1.1rem; }
        .btn-delete-project { background: transparent; color: #94a3b8; border: 1px solid #e2e8f0; width: 100%; max-width: 400px; margin-top: 50px; font-size: 0.8rem; }
        .btn-delete-project:hover { background: #fff1f2; color: var(--danger); border-color: var(--danger); }
        
        .shift-item { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; background: #f8fafc; padding: 10px; border-radius: 8px; }
        .drag-handle { cursor: grab; color: #cbd5e1; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3>ã‚·ãƒ•ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h3>
    
    <div class="sidebar-label">åŸºæœ¬ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
    <div class="nav-item nav-active" id="nav-projects" onclick="showSection('projects')">ğŸ“ æ¡ˆä»¶ä¸€è¦§ãƒ»æ–°è¦ä½œæˆ</div>

    <div class="sidebar-label">ã‚·ãƒ•ãƒˆæå‡ºãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª</div>
    <div id="sidebar-admin-links">
        </div>

    <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
        <p id="user-display" style="font-size: 0.7rem; color: rgba(255,255,255,0.5); margin-bottom: 10px;"></p>
        <button onclick="logout()" style="background:rgba(255,255,255,0.05); color:white; border:1px solid rgba(255,255,255,0.1); width: 100%; padding: 8px; font-size: 0.8rem;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
</div>

<div id="main-content">
    <section id="sec-projects">
        <h1>æ¡ˆä»¶ä¸€è¦§</h1>
        <div class="card" style="text-align: right;">
            <button class="btn-primary" onclick="createNewProject()">+ æ–°ã—ã„æ¡ˆä»¶ã‚’ä½œæˆ</button>
        </div>
        <div id="project-list-container"></div>
    </section>

    <section id="sec-edit-all" style="display:none;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <button class="btn-secondary" onclick="showSection('projects')">â† æ¡ˆä»¶ä¸€è¦§ã«æˆ»ã‚‹</button>
            <div id="current-pj-badge" style="padding:8px 15px; background:var(--active-bg); color:white; border-radius:20px; font-weight:bold; font-size:0.9rem;"></div>
        </div>

        <div style="display: flex; gap: 30px; align-items: flex-start;">
            <div class="card" style="flex: 1;">
                <h3>1. è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã®è¨­å®š</h3>
                <div style="display:grid; gap:15px;">
                    <div><label style="font-size:0.8rem; font-weight:bold;">ç®¡ç†ç”¨åç§°</label><input type="text" id="field-title_tag" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px;"></div>
                    <div><label style="font-size:0.8rem; font-weight:bold;">è¦‹å‡ºã—</label><input type="text" id="field-h1_title" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px;"></div>
                    <div><label style="font-size:0.8rem; font-weight:bold;">å†’é ­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</label><textarea id="field-msg_top" rows="3" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:5px;"></textarea></div>
                    <div style="background:#f1f5f9; padding:15px; border-radius:10px;">
                        <p style="margin:0 0 10px 0; font-size:0.8rem; font-weight:bold;">é…å¸ƒç”¨URL (ã‚³ãƒ”ãƒ¼ã—ã¦ã‚¹ã‚¿ãƒƒãƒ•ã¸é€ä¿¡)</p>
                        <input type="text" id="target-url" readonly style="width:100%; padding:8px; background:#fff; border:1px solid #cbd5e1; border-radius:5px; font-size:0.8rem;">
                    </div>
                </div>
            </div>

            <div class="card" style="flex: 1;">
                <h3>2. ã‚·ãƒ•ãƒˆæ ã®ç¨®é¡</h3>
                <div id="shift-list"></div>
                <button class="btn-secondary" style="width: 100%; margin-top: 15px;" onclick="addShiftRow()">+ æ ã‚’è¿½åŠ </button>
            </div>
        </div>

        <div style="text-align: center; margin-top: 40px;">
            <button class="btn-save-all" onclick="saveAllSettings()">ã™ã¹ã¦ã®è¨­å®šã‚’ä¿å­˜ã—ã¦åæ˜ ã™ã‚‹</button><br>
            <button class="btn-delete-project" onclick="deleteCurrentProject()">ã“ã®æ¡ˆä»¶ã‚’å®Œå…¨ã«å‰Šé™¤ã™ã‚‹</button>
        </div>
    </section>
</div>

<script>
    const S_URL = 'https://vryxvtzrvmtyryugqzlp.supabase.co';
    const S_KEY = 'sb_publishable_RnuLQC0N_wYOrwLFQIf5Gg_O-g_bc2m';
    const client = supabase.createClient(S_URL, S_KEY);
    let currentProjectId = null;

    // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆã‚µã‚¤ãƒ‰ãƒãƒ¼ã¨ä¸€è¦§ã®ä¸¡æ–¹ã‚’æ›´æ–°ï¼‰
    async function loadAllData() {
        const { data: projects, error } = await client.from('projects').select('*').order('created_at', { ascending: false });
        if(error) return;

        // 1. æ¡ˆä»¶ä¸€è¦§ã‚«ãƒ¼ãƒ‰ã®ç”Ÿæˆ
        const container = document.getElementById('project-list-container');
        container.innerHTML = projects.map(pj => `
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div style="font-size:1.1rem; font-weight:bold;">${pj.title_tag}</div>
                    <div style="font-size:0.8rem; color:#64748b;">ä½œæˆæ—¥: ${new Date(pj.created_at).toLocaleDateString()}</div>
                </div>
                <button class="btn-primary" onclick="selectProject('${pj.id}')">è¨­å®šã‚’ç·¨é›†ã™ã‚‹</button>
            </div>
        `).join('');

        // 2. ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒªãƒ³ã‚¯ä¸€è¦§ã®ç”Ÿæˆï¼ˆææ¡ˆ2ã®å®Ÿè£…ï¼‰
        const sidebarAdmin = document.getElementById('sidebar-admin-links');
        sidebarAdmin.innerHTML = projects.map(pj => `
            <a href="admin.htm?id=${pj.id}" target="_blank" class="nav-item admin-link">
                ${pj.title_tag}
            </a>
        `).join('');
    }

    async function selectProject(id) {
        currentProjectId = id;
        const { data: pj } = await client.from('projects').select('*').eq('id', id).single();
        if (!pj) return;

        document.getElementById('current-pj-badge').textContent = `æ¡ˆä»¶: ${pj.title_tag}`;
        document.getElementById('field-title_tag').value = pj.title_tag || '';
        document.getElementById('field-h1_title').value = pj.h1_title || '';
        document.getElementById('field-msg_top').value = pj.msg_top || '';

        const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
        document.getElementById('target-url').value = `${baseUrl}/index.htm?id=${id}`;

        loadShifts(id);
        showSection('edit-all');
    }

    // --- ä»¥ä¸‹ã€è£œåŠ©é–¢æ•°ï¼ˆä¿å­˜ã€å‰Šé™¤ã€ã‚·ãƒ•ãƒˆæ è¿½åŠ ãªã©ï¼‰ ---

    async function loadShifts(id) {
        const { data: shifts } = await client.from('shift_types').select('*').eq('project_id', id).order('display_order');
        const list = document.getElementById('shift-list');
        list.innerHTML = '';
        if(shifts && shifts.length > 0) shifts.forEach(s => addShiftRow(s.name));
        else addShiftRow('ä¼‘ã¿');
    }

    function addShiftRow(name = '') {
        const div = document.createElement('div');
        div.className = 'shift-item';
        div.innerHTML = `<div class="drag-handle">â˜°</div><input type="text" class="shift-name-input" value="${name}" style="flex:1; padding:8px; border:1px solid #ddd; border-radius:5px;"><button onclick="this.parentElement.remove()" style="background:none; color:var(--danger); font-size:0.8rem;">å‰Šé™¤</button>`;
        document.getElementById('shift-list').appendChild(div);
    }

    async function saveAllSettings() {
        if (!currentProjectId) return;
        const btn = document.querySelector('.btn-save-all');
        btn.innerText = "ä¿å­˜ä¸­...";

        await client.from('projects').update({
            title_tag: document.getElementById('field-title_tag').value,
            h1_title: document.getElementById('field-h1_title').value,
            msg_top: document.getElementById('field-msg_top').value
        }).eq('id', currentProjectId);

        await client.from('shift_types').delete().eq('project_id', currentProjectId);
        const newShifts = Array.from(document.querySelectorAll('.shift-item')).map((row, i) => ({
            project_id: currentProjectId, name: row.querySelector('.shift-name-input').value, display_order: i
        })).filter(s => s.name.trim() !== '');
        
        if(newShifts.length > 0) await client.from('shift_types').insert(newShifts);
        
        alert("è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒªãƒ³ã‚¯ã‚‚æ›´æ–°ã•ã‚Œã¾ã—ãŸã€‚");
        btn.innerText = "ã™ã¹ã¦ã®è¨­å®šã‚’ä¿å­˜ã—ã¦åæ˜ ã™ã‚‹";
        loadAllData(); // ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æœ€æ–°ã®æ¡ˆä»¶åã«æ›´æ–°
    }

    async function deleteCurrentProject() {
        if (!confirm("ã€è­¦å‘Šã€‘ã“ã®æ¡ˆä»¶ã¨ã€ã‚¹ã‚¿ãƒƒãƒ•ã‹ã‚‰å±Šã„ãŸæå‡ºãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
        await client.from('submissions').delete().eq('project_id', currentProjectId);
        await client.from('shift_types').delete().eq('project_id', currentProjectId);
        await client.from('projects').delete().eq('id', currentProjectId);
        alert("å‰Šé™¤ã—ã¾ã—ãŸã€‚");
        showSection('projects');
        loadAllData();
    }

    async function createNewProject() {
        const name = prompt("æ–°ã—ã„æ¡ˆä»¶åï¼ˆä¾‹ï¼š1æœˆåˆ†ç¾å ´ã‚·ãƒ•ãƒˆï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        if (!name) return;
        const { data } = await client.from('projects').insert([{ title_tag: name, h1_title: 'ã‚·ãƒ•ãƒˆå¸Œæœ›æå‡º' }]).select();
        loadAllData();
        if(data) selectProject(data[0].id);
    }

    function showSection(id) {
        document.querySelectorAll('section').forEach(s => s.style.display = 'none');
        document.getElementById('sec-' + id).style.display = 'block';
        document.getElementById('nav-projects').classList.toggle('nav-active', id === 'projects');
    }

    window.onload = async () => {
        const { data: { session } } = await client.auth.getSession();
        if (session) {
            document.getElementById('user-display').textContent = `ç®¡ç†è€…: ${session.user.email}`;
            loadAllData();
        } else {
            // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆç­‰ã®å‡¦ç†
        }
    };
</script>
</body>
</html>
